{% extends 'layouts/base.html' %}
{% load static %}
{% load custom_filters %}
{% block title %} CIP Register {% endblock title %}
{% block stylesheets %}
{{ block.super }}
<style>
   /* Table Styles */
   .table {
      white-space: normal; /* Changed from nowrap */
   }
   
   /* Cell content styling */
   .table td {
      max-width: none; /* Remove max-width constraint */
      white-space: normal; /* Allow text wrapping */
      word-wrap: break-word; /* Break long words */
      padding: 10px; /* Add more padding */
      vertical-align: top; /* Align content to top */
      line-height: 1.4; /* Improve line height for readability */
   }

   .table td.description-cell,
   .table td.area-cell {
      min-height: 50px; /* Minimum height for content */
      height: auto; /* Allow height to grow */
      overflow: visible; /* Show all content */
      text-overflow: clip; /* Don't ellipsis */
   }

      /* Editable cells */
      [contenteditable="true"] {
      min-height: 40px; /* Minimum height for editing */
      padding: 8px; /* More padding for editing */
      border: 1px solid transparent;
      border-radius: 4px;
      transition: all 0.2s ease;
   }

   [contenteditable="true"]:hover {
      border-color: #dee2e6;
      background-color: #f8f9fa;
   }

   .table th:nth-child(1), 
   .table td:nth-child(1) {  /* CIP No column */
      min-width: 150px;
      width: 150px;
   }

   .table th:nth-child(14), 
   .table td:nth-child(14),  /* Start Date column */
   .table th:nth-child(15), 
   .table td:nth-child(15) { /* End Date column */
      min-width: 140px;
      width: 140px;
   }

   /* Impact Tags */
   .impact-list {
   display: flex;
   flex-wrap: wrap;
   gap: 5px;
   }
   .impact-tag {
   background-color: #e3f2fd;
   padding: 3px 8px;
   border-radius: 4px;
   font-size: 0.9em;
   color: #1976d2;
   }
   .impact-tag-clickable {
   cursor: pointer;
   border: none;
   transition: all 0.2s ease;
   }
   .impact-tag-clickable:hover {
   background-color: #800000;
   color: white;
   }
   .impact-tag-clickable i {
   margin-right: 4px;
   }
   /* File Links */
   .files-container a {
   color: #800000;
   text-decoration: none;
   }
   /* Action Buttons */
   .action-buttons {
   display: flex;
   gap: 8px;
   }
   .save-btn, .approve-btn {
   padding: 0.5rem 1rem;
   border-radius: 0.375rem;
   font-size: 0.875rem;
   font-weight: 600;
   border: none;
   cursor: pointer;
   }
   .save-btn {
   background-color: #800000;
   color: white;
   }
   .approve-btn {
   background-color: #800000;
   color: white;
   }
   /* Status Colors */
   .status-approved {
   color: #2dce89;
   font-weight: 600;
   }
   .status-rejected {
   color: #f5365c;
   font-weight: 600;
   }
   .status-pending {
   color: #fb6340;
   font-weight: 600;
   }
   /* Month Select */
   .month-select-container {
        width: 140px;
        padding: 0;
    }
    
    .month-select.form-control {
        width: 100%;
        height: 38px;
        padding: 6px 12px;
        font-size: 0.875rem;
        line-height: 1.5;
        border: 1px solid #dee2e6;
        border-radius: 4px;
        -webkit-appearance: menulist;
        -moz-appearance: menulist;
        appearance: menulist;
    }
    
    .month-select.form-control option {
        padding: 6px 12px;
        font-size: 0.875rem;
        line-height: 1.5;
    }
   /* Modal Styles */
   .modal-content {
   border: 0;
   border-radius: .375rem;
   }
   .modal-header {
   padding: 1.25rem;
   border-bottom: 1px solid #e9ecef;
   }
   .modal-body {
   padding: 1.5rem;
   }
   /* Header Background */
   .bg-primary {
   background: radial-gradient(circle at center,
   rgba(128, 0, 0, 0.8) 0%,
   rgba(96, 0, 0, 0.9) 100%) !important;
   }
   /* Buttons */
   .btn-primary, .btn-success, .btn-info {
   background-color: #800000;
   border-color: #800000;
   color: white;
   }
   .btn-primary:hover, .btn-success:hover, .btn-info:hover {
   background-color: #600000;
   border-color: #600000;
   }

   .bg-card-color{
   background:  rgba(255, 248, 248, 0.6)!important;
   padding-top: 2rem;
   }
   .thead-light {
   background: rgba(255, 242, 242, 0.1) !important;
   }
   .thead-light th {
   color: #333333 !important;
   border-color: rgba(128, 0, 0, 0.2) !important;
   }
       /* Pagination Styling */
       .pagination {
        margin-bottom: 0;
    }
    
    .page-link {
        color: #800000;
        padding: 0.5rem 0.75rem;
        line-height: 1.25;
        border: 1px solid #dee2e6;
    }
    
    .page-link:hover {
        color: #600000;
        background-color: #e9ecef;
        border-color: #dee2e6;
    }
    
    .page-item.active .page-link {
        background-color: #800000;
        border-color: #800000;
    }
    
    .page-item.disabled .page-link {
        color: #8898aa;
    }

    #sheetsPerPage {
        width: 150px !important;
        display: inline-block;
        margin: 0 auto;
    }
    .approval-flow {
   font-size: 0.9rem;
   }
   .approval-flow ol {
   margin: 10px 0;
   padding-left: 20px;
   }
   .approval-flow li {
   margin-bottom: 5px;
   }
   .approval-flow p:last-child {
   margin-bottom: 0;
   font-weight: 600;
   }
   input[type="number"] {
   appearance: textfield;
   -moz-appearance: textfield;
   }
   input[type="number"]::-webkit-outer-spin-button,
   input[type="number"]::-webkit-inner-spin-button {
   -webkit-appearance: none;
   margin: 0;
   }
   .impact-tag-clickable {
   cursor: pointer;
   border: none;
   transition: all 0.2s ease;
   }
   .impact-tag-clickable:hover {
   background-color: #5e72e4;
   color: white;
   }
   .impact-tag-clickable i {
   margin-right: 4px;
   }
   .modal-content {
   border: 0;
   border-radius: .375rem;
   }
   .modal-header {
   padding: 1.25rem;
   border-bottom: 1px solid #e9ecef;
   }
   .modal-body {
   padding: 1.5rem;
   }
   .table th {
   font-weight: 600;
   color: #8898aa;
   }
   .button-container {
    display: flex;
    flex-direction: column;
    gap: 8px;
    }

    .action-buttons {
        display: flex;
        gap: 8px;
    }

    .additional-buttons {
        display: flex;
        flex-direction: column;
        gap: 8px;
    }

    .btn {
        width: fit-content;
    }
    .area-grouping-container {
    position: relative;
}

.area-grouping-container .area-display {
    margin-bottom: 8px;
    font-weight: 500;
    min-height: 20px;
    padding: 4px;
    border-radius: 4px;
    background-color: #f8f9fa;
}

.area-grouping-select {
    width: 100%;
    margin-top: 4px;
}

.text-success {
    color: #2dce89 !important;
}

.text-danger {
    color: #f5365c !important;
}

.text-muted {
    color: #8898aa !important;
}

#costDifferenceType {
    display: inline-block;
    margin-right: 5px;
}

#costDifferenceValue {
    display: inline-block;
    font-weight: bold;
}

</style>
{% endblock stylesheets %}
{% block content %}
<!-- Header -->
<div class="header bg-primary pb-6">
   <div class="container-fluid">
      <div class="header-body">
         <div class="row align-items-center py-4">
            <div class="col-lg-6 col-7">
               <h6 class="h2 text-white d-inline-block mb-0">CIP Register</h6>
               <nav aria-label="breadcrumb" class="d-none d-md-inline-block ml-md-4">
                  <ol class="breadcrumb breadcrumb-links breadcrumb-dark">
                     <li class="breadcrumb-item">
                        <a href="{% url 'coordinator_dashboard' %}">
                        <i class="fas fa-home"></i> Dashboard
                        </a>
                     </li>
                     <li class="breadcrumb-item ">
                        <button class="btn" onclick="downloadCIPRegister()">
                        <i class="fas fa-download mr-2"></i>Download CIP Register
                        </button>
                     </li>
                  </ol>
               </nav>
            </div>
         </div>
      </div>
   </div>
</div>
<!-- Page content -->
<div class="bg-card-color mt--6">
   <div class="row">
      <div class="col">
         <div class="card">
            <div class="card-header border-0">
               <h3 class="mb-0">Kaizen Sheets Register</h3>
            </div>
            <div class="table-responsive">
               <table class="table align-items-center table-flush">
                  {% csrf_token %}
                  <thead class="thead-light">
                     <tr>
                        <th>CIP No</th>
                        <th>Reg Month</th>
                        <th>Registered Date</th>
                        <th>Financial Year</th>
                        <th>Project Status</th>
                        <th>Project Description</th>
                        <th>Project Area</th>
                        <th>Area Wise Kaizen Grouping</th>
                        <th>Project Leader</th>
                        <th>Team Member 1 ID</th>
                        <th>Team Member 1</th>
                        <th>Team Member 2 ID</th>
                        <th>Team Member 2</th>
                        <th>Start Date</th>
                        <th>End Date</th>
                        <th>Savings Start Month</th>
                        <th>Est. Savings/Year</th>
                        <th>Realized Savings</th>
                        <th>Area Of Improvement</th>
                        <th>Files & Images</th>
                        <th>Actions</th>
                     </tr>
                  </thead>
                  <tbody>
                     {% for sheet in kaizen_sheets %}
                     <tr data-sheet-id="{{ sheet.id }}"
                        data-impact-safety="{{ sheet.impacts_safety|lower }}"
                        data-impact-quality="{{ sheet.impacts_quality|lower }}"
                        data-impact-productivity="{{ sheet.impacts_productivity|lower }}"
                        data-impact-delivery="{{ sheet.impacts_delivery|lower }}"
                        data-impact-cost="{{ sheet.impacts_cost|lower }}"
                        data-impact-morale="{{ sheet.impacts_morale|lower }}"
                        data-impact-environment="{{ sheet.impacts_environment|lower }}">
                        <td>{{ sheet.serial_key }}</td>
                        <td>{{ sheet.created_at|date:"F" }}</td>
                        <td>{{ sheet.created_at|date:"Y-m-d" }}</td>
                        <td>FY {{ sheet.created_at|financial_year }}</td>
                        <td>
                            {% if sheet.approval_status == 'completed' %}
                                <span class="badge badge-success">Completed</span>
                            {% elif sheet.approval_status == 'rejected_by_hod' %}
                                <span class="badge badge-danger">Rejected by HOD</span>
                            {% elif sheet.approval_status == 'rejected_by_coordinator' %}
                                <span class="badge badge-danger">Rejected by Coordinator</span>
                            {% elif sheet.approval_status == 'rejected_by_finance' %}
                                <span class="badge badge-danger">Rejected by Finance</span>
                            {% elif sheet.approval_status == 'finance_pending' %}
                                <span class="badge badge-warning">Finance Approval Pending</span>
                            {% elif sheet.approval_status == 'coordinator_pending' %}
                                <span class="badge badge-info">Coordinator Approval Pending</span>
                            {% else %}
                                <span class="badge badge-secondary">HOD Approval Pending</span>
                            {% endif %}
                        </td>
                        <td contenteditable="true" data-field="title">{{ sheet.title }}</td>
                        <td>{{ sheet.employee.profiles.first.department }}</td>
                        <td>
                            <div class="area-grouping-container">
                                <div class="area-display">
                                    {% if sheet.area_grouping %}
                                        {% for choice in area_grouping_choices %}
                                            {% if choice.0 == sheet.area_grouping %}
                                                {{ choice.1 }}
                                            {% endif %}
                                        {% endfor %}
                                    {% else %}
                                        No area assigned
                                    {% endif %}
                                </div>
                                <select class="form-control area-grouping-select" 
                                        onchange="updateAreaGrouping('{{ sheet.id }}', this.value)" 
                                        data-original-value="{{ sheet.area_grouping }}">
                                    <option value="">Select Area Group</option>
                                    {% for choice in area_grouping_choices %}
                                        <option value="{{ choice.0 }}" {% if sheet.area_grouping == choice.0 %}selected{% endif %}>
                                            {{ choice.1 }}
                                        </option>
                                    {% endfor %}
                                </select>
                            </div>
                        </td>
                        <td>{{ sheet.project_leader }}</td>
                        <td contenteditable="true" data-field="team_member1_id">{{ sheet.team_member1_id }}</td>
                        <td>{{ sheet.employee.username }}</td>
                        <td contenteditable="true" data-field="team_member2_id">{{ sheet.team_member2_id }}</td>
                        <td contenteditable="true" data-field="team_member2">{{ sheet.team_member2 }}</td>
                        <td contenteditable="true" data-field="start_date">{{ sheet.start_date|date:"Y-m-d" }}</td>
                        <td contenteditable="true" data-field="end_date">{{ sheet.end_date|date:"Y-m-d" }}</td>
                        <td class="month-select-container">
                            <select class="form-control month-select" data-field="savings_start_month" onchange="updateSavings(this, '{{ sheet.id }}')">
                                <option value="">Select Month</option>
                                {% for month in months %}
                                    <option value="{{ month }}" {% if sheet.savings_start_month == month %}selected{% endif %}>
                                        {{ month }}
                                    </option>
                                {% endfor %}
                            </select>
                        </td>
                        <td contenteditable="true" data-field="estimated_savings">{{ sheet.estimated_savings }}</td>
                        <td contenteditable="true" data-field="realized_savings">{{ sheet.realized_savings }}</td>
                        <td class="impact-column">
                            <div class="impact-list">
                                {% if sheet.is_handwritten %}
                                    {% if sheet.impacts_safety or sheet.impacts_quality or sheet.impacts_productivity or sheet.impacts_delivery or sheet.impacts_cost or sheet.impacts_morale or sheet.impacts_environment %}
                                        <!-- Show existing impacts for handwritten sheets -->
                                        {% if sheet.impacts_safety %}
                                            <span class="impact-tag">Safety</span>
                                        {% endif %}
                                        {% if sheet.impacts_quality %}
                                            <span class="impact-tag">Quality</span>
                                        {% endif %}
                                        {% if sheet.impacts_productivity %}
                                            <span class="impact-tag">Productivity</span>
                                        {% endif %}
                                        {% if sheet.impacts_delivery %}
                                            <span class="impact-tag">Delivery</span>
                                        {% endif %}
                                        {% if sheet.impacts_cost %}
                                            <span class="impact-tag">Cost</span>
                                        {% endif %}
                                        {% if sheet.impacts_morale %}
                                            <span class="impact-tag">Morale</span>
                                        {% endif %}
                                        {% if sheet.impacts_environment %}
                                            <span class="impact-tag">Environment</span>
                                        {% endif %}
                                    {% endif %}
                                    <button onclick="openImpactSelection('{{ sheet.id }}')" 
                                            class="btn btn-sm btn-primary">
                                        <i class="fas fa-edit"></i> Edit Impacts
                                    </button>
                                {% else %}
                                    <!-- Show impacts for manually input sheets -->
                                    {% for impact in impacts %}
                                    {% with impact_info=sheet.impact_data|get_dict_item:impact %}
                                    {% if impact_info.benefits_description or impact_info.uom or impact_info.before_implementation or impact_info.after_implementation %}
                                    {% if impact == 'cost' %}
                                    <button onclick="viewCostDetails('{{ sheet.id }}')" class="impact-tag impact-tag-clickable">
                                        <i class="ni ni-money-coins"></i> Cost
                                    </button>
                                    {% else %}
                                    <span class="impact-tag">{{ impact|title }}</span>
                                    {% endif %}
                                    {% endif %}
                                    {% endwith %}
                                    {% endfor %}
                                {% endif %}
                            </div>
                        </td>
                        <td class="files-column">
                            <div class="files-container">
                               {% if sheet.standardization_file %}
                               <div class="file-link">
                                  <a href="{{ sheet.standardization_file.url }}" target="_blank" class="btn btn-sm btn-link">
                                     <i class="fas fa-file-pdf"></i> View Standardization File
                                  </a>
                               </div>
                               {% endif %}
                               {% if sheet.before_improvement_image %}
                               <div class="image-link">
                                  <a href="{{ sheet.before_improvement_image.url }}" target="_blank" class="btn btn-sm btn-link">
                                     <i class="fas fa-image"></i> View Before Image
                                  </a>
                               </div>
                               {% endif %}
                               {% if sheet.after_improvement_image %}
                               <div class="image-link">
                                  <a href="{{ sheet.after_improvement_image.url }}" target="_blank" class="btn btn-sm btn-link">
                                     <i class="fas fa-image"></i> View After Image
                                  </a>
                               </div>
                               {% endif %}
                               {% if sheet.is_handwritten and sheet.handwritten_sheet %}
                               <div class="file-link handwritten-link">
                                  <a href="{{ sheet.handwritten_sheet.url }}" target="_blank" class="btn btn-sm btn-link">
                                     <i class="fas fa-file-alt"></i> View Handwritten Sheet
                                  </a>
                               </div>
                               {% endif %}
                            </div>
                         </td>
                        <td>
                            <div class="button-container">
                                {% if sheet.approval_status == 'coordinator_pending' %}
                                    <div class="action-buttons">
                                        <button onclick="handleCoordinatorAction('{{ sheet.id }}', 'approve')" class="btn btn-sm btn-success">
                                            Approve
                                        </button>
                                        <button onclick="handleCoordinatorAction('{{ sheet.id }}', 'reject')" class="btn btn-sm btn-danger">
                                            Reject
                                        </button>
                                    </div>
                                {% endif %}
                                <div class="additional-buttons">
                                    {% if sheet.get_cost_difference > 0 %}
                                        <button onclick="viewCostDetails('{{ sheet.id }}')" class="btn btn-sm btn-info">
                                            <i class="ni ni-money-coins"></i> Cost Details
                                        </button>
                                    {% endif %}
                                    <button onclick="saveChanges(this)" data-sheet-id="{{ sheet.id }}" class="btn btn-sm btn-primary">
                                        Save
                                    </button>
                                </div>
                            </div>
                        </td>
                        </td>
                     </tr>
                     {% endfor %}
                  </tbody>
               </table>
               <!-- Add this right after the table, before closing the card div -->
<!-- Replace the existing pagination section -->
<div class="card-footer py-4">
    <nav aria-label="Page navigation">
        <ul class="pagination justify-content-center mb-0">
            <!-- First and Previous Page -->
            <li class="page-item {% if not kaizen_sheets.has_previous %}disabled{% endif %}">
                <a class="page-link" href="?page=1&items_per_page={{ items_per_page }}" aria-label="First">
                    <i class="fas fa-angle-double-left"></i>
                </a>
            </li>
            <li class="page-item {% if not kaizen_sheets.has_previous %}disabled{% endif %}">
                <a class="page-link" href="{% if kaizen_sheets.has_previous %}?page={{ kaizen_sheets.previous_page_number }}&items_per_page={{ items_per_page }}{% else %}#{% endif %}" aria-label="Previous">
                    <i class="fas fa-angle-left"></i>
                </a>
            </li>

            <!-- Page Numbers -->
            {% for num in kaizen_sheets.paginator.page_range %}
                {% if num == kaizen_sheets.number %}
                    <li class="page-item active">
                        <span class="page-link">{{ num }}</span>
                    </li>
                {% elif num > kaizen_sheets.number|add:'-3' and num < kaizen_sheets.number|add:'3' %}
                    <li class="page-item">
                        <a class="page-link" href="?page={{ num }}&items_per_page={{ items_per_page }}">{{ num }}</a>
                    </li>
                {% endif %}
            {% endfor %}

            <!-- Next and Last Page -->
            <li class="page-item {% if not kaizen_sheets.has_next %}disabled{% endif %}">
                <a class="page-link" href="{% if kaizen_sheets.has_next %}?page={{ kaizen_sheets.next_page_number }}&items_per_page={{ items_per_page }}{% else %}#{% endif %}" aria-label="Next">
                    <i class="fas fa-angle-right"></i>
                </a>
            </li>
            <li class="page-item {% if not kaizen_sheets.has_next %}disabled{% endif %}">
                <a class="page-link" href="{% if kaizen_sheets.has_next %}?page={{ kaizen_sheets.paginator.num_pages }}&items_per_page={{ items_per_page }}{% else %}#{% endif %}" aria-label="Last">
                    <i class="fas fa-angle-double-right"></i>
                </a>
            </li>
        </ul>
    </nav>

    <!-- Items per page selector -->
    <div class="text-center mt-3">
        <div class="d-inline-block">
            <select id="sheetsPerPage" class="form-control form-control-sm" style="width: auto;" onchange="changeItemsPerPage(this.value)">
                <option value="5" {% if items_per_page == 5 %}selected{% endif %}>5 sheets per page</option>
                <option value="50" {% if items_per_page == 50 %}selected{% endif %}>50 sheets per page</option>
                <option value="100" {% if items_per_page == 100 %}selected{% endif %}>100 sheets per page</option>
                <option value="200" {% if items_per_page == 200 %}selected{% endif %}>200 sheets per page</option>
            </select>
        </div>
        <div class="d-inline-block ml-3">
            <span class="text-muted">
                Page {{ kaizen_sheets.number }} of {{ kaizen_sheets.paginator.num_pages }} 
                (Total: {{ kaizen_sheets.paginator.count }} sheets)
            </span>
        </div>
    </div>
</div>
            </div>
         </div>
      </div>
   </div>
</div>
<div class="modal fade" id="costDetailsModal" tabindex="-1" role="dialog" aria-labelledby="costDetailsModalLabel" aria-hidden="true">
   <div class="modal-dialog modal-dialog-centered" role="document">
      <div class="modal-content">
         <div class="modal-header">
            <h5 class="modal-title">Cost Impact Details</h5>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
            </button>
         </div>
         <div class="modal-body">
            <div class="table-responsive">
               <table class="table align-items-center">
                  <tbody>
                     <tr>
                        <th>Benefits Description:</th>
                        <td id="costBenefitsDescription"></td>
                     </tr>
                     <tr>
                        <th>UOM:</th>
                        <td id="costUOM"></td>
                     </tr>
                     <tr>
                        <th>Before Implementation:</th>
                        <td id="costBefore"></td>
                     </tr>
                     <tr>
                        <th>After Implementation:</th>
                        <td id="costAfter"></td>
                     </tr>
                     <tr>
                        <th>Cost:</th>
                        <td>
                            <span id="costDifferenceType" class="font-weight-bold"></span>
                            <span id="costDifferenceValue"></span>
                        </td>
                    </tr>
                  </tbody>
               </table>
            </div>
            <div id="costCalculationDoc" class="mt-3"></div>
         </div>
      </div>
   </div>
</div>

<div class="modal fade" id="impactSelectionModal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Select Impact Areas</h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="impact-checkboxes">
                    <div class="form-check mb-2">
                        <input type="checkbox" class="form-check-input" id="impact_safety">
                        <label class="form-check-label" for="impact_safety">Safety</label>
                    </div>
                    <div class="form-check mb-2">
                        <input type="checkbox" class="form-check-input" id="impact_quality">
                        <label class="form-check-label" for="impact_quality">Quality</label>
                    </div>
                    <div class="form-check mb-2">
                        <input type="checkbox" class="form-check-input" id="impact_productivity">
                        <label class="form-check-label" for="impact_productivity">Productivity</label>
                    </div>
                    <div class="form-check mb-2">
                        <input type="checkbox" class="form-check-input" id="impact_delivery">
                        <label class="form-check-label" for="impact_delivery">Delivery</label>
                    </div>
                    <div class="form-check mb-2">
                        <input type="checkbox" class="form-check-input" id="impact_cost">
                        <label class="form-check-label" for="impact_cost">Cost</label>
                    </div>
                    <div class="form-check mb-2">
                        <input type="checkbox" class="form-check-input" id="impact_morale">
                        <label class="form-check-label" for="impact_morale">Morale</label>
                    </div>
                    <div class="form-check mb-2">
                        <input type="checkbox" class="form-check-input" id="impact_environment">
                        <label class="form-check-label" for="impact_environment">Environment</label>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveSelectedImpacts()">Save Impacts</button>
            </div>
        </div>
    </div>
</div>
</div>
{% endblock content %}
{% block javascripts %}
{{ block.super }}
<script src="https://cdn.jsdelivr.net/npm/chart.js@2.9.4/dist/Chart.min.js"></script>
<script src="https://unpkg.com/exceljs/dist/exceljs.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
<script>
   function toggleImpactFields(impact, sheetId) {
       const btn = document.getElementById(`btn_${impact}_${sheetId}`);
       const fields = document.getElementById(`fields_${impact}_${sheetId}`);
       
       if (fields.style.display === 'none') {
           const impactData = {
               benefits: `${impact}_benefits_description`,
               uom: `${impact}_uom`,
               before: `${impact}_before_implementation`,
               after: `${impact}_after_implementation`
           };
   
           Object.keys(impactData).forEach(key => {
               const value = getImpactData(sheetId, impactData[key]);
               document.getElementById(`${impact}_${key}_${sheetId}`).textContent = value;
           });
   
           fields.style.display = 'block';
           btn.classList.add('active');
       } else {
           fields.style.display = 'none';
           btn.classList.remove('active');
       }
   }
   
   function approveKaizen(sheetId) {
       if (confirm('Are you sure you want to approve this kaizen?')) {
           fetch(`/coordinator-approve-kaizen/${sheetId}/`, {
               method: 'POST',
               headers: {
                   'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
               }
           })
           .then(response => response.json())
           .then(data => {
               if (data.success) {
                   location.reload();
               } else {
                   alert('Error approving kaizen: ' + (data.error || 'Unknown error'));
               }
           })
           .catch(error => {
               console.error('Error:', error);
               alert('Error approving kaizen');
           });
       }
   }
   
   function handleCoordinatorApproval(sheetId) {
       if(!confirm('Are you sure you want to approve this kaizen?')) return;
       
       const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
       
       fetch(`/coordinator-approve-kaizen/${sheetId}/`, {
           method: 'POST',
           headers: {
               'X-CSRFToken': csrfToken,
               'Content-Type': 'application/json'
           }
       })
       .then(response => response.json())
       .then(data => {
           if(data.success) {
               location.reload();
           } else {
               alert(data.error || 'Error approving kaizen');
           }
       })
       .catch(error => {
           console.error('Error:', error);
           alert('Error approving kaizen');
       });
   }
   
   function handleCoordinatorAction(sheetId, action) {
        if(!confirm(`Are you sure you want to ${action} this kaizen?`)) return;
        
        const button = event.target;
        button.disabled = true;
        button.innerHTML = `<i class="fas fa-spinner fa-spin"></i> ${action === 'approve' ? 'Approving...' : 'Rejecting...'}`;
        
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
        const url = action === 'approve' ? `/coordinator-approve-kaizen/${sheetId}/` : `/reject-kaizen/${sheetId}/`;

        fetch(url, {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrfToken,
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if(data.success) {
                location.reload();
            } else {
                alert(data.error || `Error ${action}ing kaizen`);
                button.disabled = false;
                button.innerHTML = action === 'approve' ? 'Approve' : 'Reject';
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert(`Error ${action}ing kaizen`);
            button.disabled = false;
            button.innerHTML = action === 'approve' ? 'Approve' : 'Reject';
        });
    }

// Update the updateAreaGrouping function
function updateAreaGrouping(sheetId, value) {
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    const container = event.target.closest('.area-grouping-container');
    const select = container.querySelector('select');
    const display = container.querySelector('.area-display');
    
    // Store original values
    const originalValue = select.getAttribute('data-original-value');
    const originalDisplay = display.textContent;
    
    // Disable select while updating
    select.disabled = true;
    
    fetch(`/update-kaizen/${sheetId}/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': csrfToken,
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            area_grouping: value
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Update select and display
            select.value = value;
            select.setAttribute('data-original-value', value);
            const selectedOption = select.options[select.selectedIndex];
            display.textContent = selectedOption ? selectedOption.text : 'No area assigned';
            
            console.log('Area grouping updated:', {
                value: value,
                text: selectedOption ? selectedOption.text : 'No area assigned'
            });
        } else {
            // Revert changes on error
            select.value = originalValue;
            display.textContent = originalDisplay;
            alert('Error updating area grouping: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        select.value = originalValue;
        display.textContent = originalDisplay;
        alert('Error updating area grouping');
    })
    .finally(() => {
        select.disabled = false;
    });
}


let currentKaizenId = null;

function openImpactSelection(kaizenId) {
    currentKaizenId = kaizenId;
    
    // Get current impacts from data attributes
    const row = document.querySelector(`tr[data-sheet-id="${kaizenId}"]`);
    const impacts = ['safety', 'quality', 'productivity', 'delivery', 'cost', 'morale', 'environment'];
    
    // Clear previous selections
    document.querySelectorAll('.impact-checkboxes input[type="checkbox"]')
        .forEach(checkbox => checkbox.checked = false);
    
    // Check boxes based on existing impacts
    impacts.forEach(impact => {
        const hasImpact = row.getAttribute(`data-impact-${impact}`);
        const checkbox = document.getElementById(`impact_${impact}`);
        if (checkbox && hasImpact === 'true') {
            checkbox.checked = true;
        }
    });
    
    $('#impactSelectionModal').modal('show');
}

function saveSelectedImpacts() {
    if (!currentKaizenId) return;
    
    const selectedImpacts = Array.from(
        document.querySelectorAll('.impact-checkboxes input[type="checkbox"]:checked')
    ).map(checkbox => checkbox.id.replace('impact_', ''));
    
    fetch(`/update-kaizen-impacts/${currentKaizenId}/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: JSON.stringify({
            impacts: selectedImpacts
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Update impact tags display
            const impactList = document.querySelector(`tr[data-sheet-id="${currentKaizenId}"] .impact-list`);
            impactList.innerHTML = selectedImpacts
                .map(impact => `<span class="impact-tag">${impact.charAt(0).toUpperCase() + impact.slice(1)}</span>`)
                .join('');
            
            $('#impactSelectionModal').modal('hide');
        } else {
            alert('Error updating impacts: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error updating impacts');
    });
}

function viewCostDetails(sheetId) {
    fetch(`/get-cost-details/${sheetId}/`)
        .then(response => response.json())
        .then(data => {
            document.getElementById('costBenefitsDescription').textContent = data.benefits_description || 'N/A';
            document.getElementById('costUOM').textContent = data.uom || 'N/A';
            document.getElementById('costBefore').textContent = data.before_implementation ? `₹${parseFloat(data.before_implementation).toLocaleString()}` : 'N/A';
            document.getElementById('costAfter').textContent = data.after_implementation ? `₹${parseFloat(data.after_implementation).toLocaleString()}` : 'N/A';

            // Calculate cost difference and determine if it's a saving or increase
            const before = parseFloat(data.before_implementation) || 0;
            const after = parseFloat(data.after_implementation) || 0;
            const differenceType = document.getElementById('costDifferenceType');
            const differenceValue = document.getElementById('costDifferenceValue');

            if (before > after) {
                // Cost saving
                const saving = before - after;
                differenceType.textContent = 'Cost Savings: ';
                differenceType.className = 'font-weight-bold text-success';
                differenceValue.textContent = `₹${saving.toLocaleString()}`;
                differenceValue.className = 'text-success';
            } else if (after > before) {
                // Cost increase
                const increase = after - before;
                differenceType.textContent = 'Cost Increase: ';
                differenceType.className = 'font-weight-bold text-danger';
                differenceValue.textContent = `₹${increase.toLocaleString()}`;
                differenceValue.className = 'text-danger';
            } else {
                // No change
                differenceType.textContent = 'No Cost Impact';
                differenceType.className = 'font-weight-bold text-muted';
                differenceValue.textContent = '';
            }

            $('#costDetailsModal').modal('show');
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error fetching cost details');
        });
}
   
   function saveChanges(btn) {
       const sheetId = btn.getAttribute('data-sheet-id');
       const row = document.querySelector(`tr[data-sheet-id="${sheetId}"]`);
       const editableCells = row.querySelectorAll('[contenteditable="true"]');
       
       const data = {};
   
       editableCells.forEach(cell => {
           const field = cell.getAttribute('data-field');
           let value = cell.textContent.trim();
           data[field] = value;
       });
   
       const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
       data['csrfmiddlewaretoken'] = csrfToken;
   
       btn.disabled = true;
       const originalText = btn.textContent;
       btn.textContent = 'Saving...';
   
       fetch(`/update-kaizen/${sheetId}/`, {
           method: 'POST',
           headers: {
               'X-CSRFToken': csrfToken,
               'Content-Type': 'application/json',
           },
           body: JSON.stringify(data),
       })
       .then(response => response.json())
       .then(data => {
           if (data.success) {
               btn.textContent = 'Saved!';
               setTimeout(() => {
                   btn.textContent = originalText;
                   btn.disabled = false;
               }, 2000);
           } else {
               alert('Error saving changes: ' + data.error);
               btn.textContent = originalText;
               btn.disabled = false;
           }
       })
       .catch(error => {
           console.error('Error:', error);
           alert('Error saving changes');
           btn.textContent = originalText;
           btn.disabled = false;
       });
   }
   
   async function downloadCIPRegister() {
       try {
           const workbook = new ExcelJS.Workbook();
           
           // Fetch template
           const response = await fetch('{% url "get_excel_template" "CIP register.xlsx" %}');
           if (!response.ok) throw new Error('Failed to fetch template');
           const templateBuffer = await response.arrayBuffer();
           
           await workbook.xlsx.load(templateBuffer);
           const worksheet = workbook.getWorksheet(1);
           
           if (!worksheet) throw new Error('Worksheet not found in template');
   
           // Get all rows from table
           const tableRows = document.querySelectorAll('table tbody tr');
           
           // Write data rows starting from row 3
           tableRows.forEach((row, index) => {
               const rowNum = index + 3; // Start from row 3
               
               try {
                   const cells = row.querySelectorAll('td');
                   
                   // Parse dates correctly
                   const registeredDate = cells[2] ? new Date(cells[2].textContent.trim()) : null;
                   const startDate = cells[13] ? new Date(cells[13].textContent.trim()) : null;
                   const endDate = cells[14] ? new Date(cells[14].textContent.trim()) : null;
   
                   // Map table columns to Excel columns with corrected indices
                   worksheet.getCell(`A${rowNum}`).value = cells[0].textContent.trim(); // CIP No
                   worksheet.getCell(`B${rowNum}`).value = cells[1].textContent.trim(); // Reg Month
                   worksheet.getCell(`C${rowNum}`).value = registeredDate; // Registered Date
                   worksheet.getCell(`D${rowNum}`).value = cells[3].textContent.trim(); // Financial Year
                   worksheet.getCell(`E${rowNum}`).value = cells[4].querySelector('span').textContent.trim(); // Project Status
                   worksheet.getCell(`F${rowNum}`).value = cells[5].textContent.trim(); // Project Description
                   worksheet.getCell(`G${rowNum}`).value = cells[6].textContent.trim(); // Department
                   worksheet.getCell(`H${rowNum}`).value = cells[7].textContent.trim(); // Project Area
                   worksheet.getCell(`I${rowNum}`).value = cells[8].textContent.trim(); // Project Leader
                   worksheet.getCell(`J${rowNum}`).value = cells[9].textContent.trim(); // Team Member 1 ID
                   worksheet.getCell(`K${rowNum}`).value = cells[10].textContent.trim(); // Team Member 1
                   worksheet.getCell(`L${rowNum}`).value = cells[11].textContent.trim(); // Team Member 2 ID
                   worksheet.getCell(`M${rowNum}`).value = startDate; // Start Date
                   worksheet.getCell(`N${rowNum}`).value = endDate; // End Date
                   worksheet.getCell(`O${rowNum}`).value = Array.from(cells[18].querySelectorAll('.impact-tag'))
                       .map(tag => tag.textContent.trim())
                       .join(', '); // Impact Areas
                   worksheet.getCell(`P${rowNum}`).value = parseFloat(cells[16].textContent.trim()) || 0; // Estimated Savings
                   worksheet.getCell(`Q${rowNum}`).value = parseFloat(cells[17].textContent.trim()) || 0; // Realized Savings
   
               } catch (err) {
                   console.error(`Error processing row ${index}:`, err);
               }
           });
   
           // Format dates
           ['C', 'M', 'N'].forEach(col => {
               worksheet.getColumn(col).numFmt = 'dd-mm-yyyy';
           });
           
           // Format numbers
           ['P', 'Q'].forEach(col => {
               worksheet.getColumn(col).numFmt = '#,##0.00';
           });
   
           const buffer = await workbook.xlsx.writeBuffer();
           const blob = new Blob([buffer], { 
               type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' 
           });
           saveAs(blob, `CIP_Register_${new Date().toISOString().split('T')[0]}.xlsx`);
   
       } catch (error) {
           console.error('Error generating Excel file:', error);
           alert(`Error generating Excel file: ${error.message}`);
       }
   }
   
   function getImpactData(sheetId, field) {
       const sheet = document.querySelector(`tr[data-sheet-id="${sheetId}"]`);
       return sheet.dataset[field] || '';
   }
   
   function updateSavings(element, sheetId) {
       const value = element.value;
       const fieldName = element.dataset.field;
       
       const data = {
           id: sheetId,
           [fieldName]: value,
           csrfmiddlewaretoken: document.querySelector('[name=csrfmiddlewaretoken]').value
       };
       
       fetch(`/update-kaizen/${sheetId}/`, {
           method: 'POST',
           headers: {
               'Content-Type': 'application/json',
               'X-CSRFToken': data.csrfmiddlewaretoken,
           },
           body: JSON.stringify(data)
       })
       .then(response => response.json())
       .then(data => {
           if (data.success) {
               console.log('Updated successfully');
           } else {
               alert('Error updating data: ' + data.error);
           }
       })
       .catch(error => {
           console.error('Error:', error);
           alert('Error updating data');
       });
   }
// Update the existing changeItemsPerPage function
function changeItemsPerPage(value) {
    const currentUrl = new URL(window.location.href);
    currentUrl.searchParams.set('items_per_page', value);
    currentUrl.searchParams.set('page', '1'); // Reset to first page
    window.location.href = currentUrl.toString();
}
</script>
{% endblock javascripts %}