{% extends 'layouts/base.html' %}
{% load static %}
{% block title %} Coordinator Dashboard {% endblock title %}
{% block stylesheets %}
<link href="https://cdn.jsdelivr.net/npm/chart.js@2.9.4/dist/Chart.min.css" rel="stylesheet">
<style>
   /* Chart Container Styling */
   .chart-row {
   margin-bottom: 30px;
   }
   .bg-gradient-default {
   background: linear-gradient(87deg, #172b4d 0, #1a174d 100%) !important;
   }
   .chart-container {
   height: 300px;
   margin: 0 auto;
   max-width: 500px;
   }
   .card-header.bg-transparent {
   border-bottom: 1px solid rgba(255, 255, 255, 0.1);
   }
   /* Chart Canvas Styling */
   .chart-canvas {
   height: 300px;
   }

/* Update the chart-card styles */
.chart-card {
    height: 100%;
    display: flex;
    flex-direction: column;
}

.chart-card .card-body {
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 2rem;
    min-height: 400px; /* Increased minimum height */
}

.chart-card .chart {
    width: 100%;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
}

.chart-card canvas {
    width: 100% !important;
    height: auto !important;
    max-width: 400px; /* Increased max-width */
    margin: 0 auto;
}

/* Ensure the legend is centered and properly sized */
.chart-card .chartjs-legend {
    display: flex;
    justify-content: center;
    width: 100%;
    margin-top: 1.5rem;
}

.chart-card .chartjs-legend ul li span {
    font-size: 0.875rem !important; /* Increased legend text size */
}
   /* Card Stats Styling */
   .bg-card-color{
   background:  rgba(255, 248, 248, 0.6)!important;
   padding-top: 2rem;
   }
   .card-stats {
   margin: 0 auto;
   max-width: 300px;
   transition: all .15s ease;
   border: 0;
   border-radius: 0.375rem;
   box-shadow: 0 0 2rem 0 rgba(128, 0, 0, 0.15);
   }
   .card-stats:hover {
   transform: translateY(-1px);
   box-shadow: 0 7px 14px rgba(128, 0, 0, 0.1), 0 3px 6px rgba(0, 0, 0, .08);
   }
   /* Chart Box Styling */
   .chart-box {
   width: 100%;
   max-width: 600px;
   margin: 0 auto;
   padding: 1.5rem;
   background: white;
   border-radius: .375rem;
   box-shadow: 0 0 2rem 0 rgba(136, 152, 170, .15);
   }
   .chart-title {
   color: #800000;
   }
   /* Year Selector Styling */
   .year-selector {
   margin-bottom: 1.5rem;
   }
   .year-selector select {
   display: block;
   width: 100%;
   height: calc(1.5em + 1.25rem + 2px);
   padding: .625rem .75rem;
   font-size: .875rem;
   font-weight: 400;
   line-height: 1.5;
   color: #8898aa;
   background-color: #fff;
   background-clip: padding-box;
   border: 1px solid #dee2e6;
   border-radius: .375rem;
   transition: all .15s ease-in-out;
   }
   .year-selector select:focus {
   color: #8898aa;
   background-color: #fff;
   border-color: #800000;
   outline: 0;
   box-shadow: 0 3px 9px rgba(128, 0, 0, 0), 3px 4px 8px rgba(128, 0, 0, .1);
   }

   .card {
   box-shadow: 0 0 2rem 0 rgba(136, 152, 170, .15);
   border: 0;
   }
   .card-header {
   padding: 1.25rem 1.5rem;
   border-bottom: 1px solid rgba(0,0,0,.05);
   }
   .card-stats {
   cursor: pointer;
   transition: transform 0.2s;
   }
   .card-stats:hover {
   transform: translateY(-3px);
   }
   .bg-primary {
   background: radial-gradient(circle at center,
   rgba(128, 0, 0, 0.8) 0%,
   rgba(96, 0, 0, 0.9) 100%) !important;
   }
   .download-btn {
   position: absolute;
   top: 1rem;
   right: 1rem;
   padding: 0.5rem 1rem;
   background: #800000;
   color: white;
   border: none;
   border-radius: 0.375rem;
   cursor: pointer;
   z-index: 1;
   }
   .download-btn:hover {
   background: #008194;
   }
   .container-fluid {
   padding-top: 2rem;
   }

   .year-selector .btn-group {
    margin-right: 1rem;
}

.year-selector .btn {
    min-width: 120px;
}

.year-selector .btn.active {
    background-color: #800000;
    border-color: #800000;
}

#yearSelect {
    min-width: 150px;
}

.calendar-year, .financial-year {
    display: none;
}

[data-year-type="calendar"] .calendar-year {
    display: inline;
}

[data-year-type="financial"] .financial-year {
    display: inline;
}
/* Add these CSS rules to your existing styles */
.chart {
    position: relative;
    width: 100%;
    min-width: 400px !important;
    height: 400px !important;
}

#yearlyPerformanceChart, #sheetsPerEmployeeChart {
    width: 100% !important;
    min-width: 400px !important;
    height: 400px !important;
}

.col-xl-6 .card {
    min-width: 450px !important;
    width: 100% !important;
}

.coordinator-input {
   min-width: 150px;
   padding: 4px 8px;
   border: 1px solid #dee2e6;
   border-radius: 4px;
   }
   .coordinator-input:focus {
   border-color: #5e72e4;
   outline: none;
   box-shadow: 0 0 0 0.2rem rgba(94,114,228,.25);
   }
   .dropdown {
   margin-left: 15px;
   }
   .dropdown-menu {
   min-width: 200px;
   }
   .dropdown-item {
   padding: 0.5rem 1rem;
   font-size: 0.875rem;
   }
   .dropdown-item:hover {
   background-color: #f6f9fc;
   }
</style>
{% endblock stylesheets %}
{% block content %}
<!-- Header -->
<div class="header bg-primary pb-6">
   <div class="container-fluid">
      <div class="header-body">
         <!-- Card stats -->
         <div class="row">
            <div class="col-xl-4 col-md-6">
               <div class="card card-stats" onclick="showEmployeeStats()">
                  <div class="card-body">
                     <div class="row">
                        <div class="col">
                           <h5 class="card-title text-uppercase text-muted mb-0">Total Kaizens</h5>
                           <span class="h2 font-weight-bold mb-0">{{ total_kaizens }}</span>
                        </div>
                        <div class="col-auto">
                           <div class="icon icon-shape bg-gradient-red text-white rounded-circle shadow">
                              <i class="ni ni-active-40"></i>
                           </div>
                        </div>
                     </div>
                  </div>
               </div>
            </div>
            <div class="col-xl-4 col-md-6">
               <div class="card card-stats">
                  <div class="card-body">
                     <div class="row">
                        <div class="col">
                           <h5 class="card-title text-uppercase text-muted mb-0">Pending Approvals</h5>
                           <span class="h2 font-weight-bold mb-0">{{ pending_approvals }}</span>
                        </div>
                        <div class="col-auto">
                           <div class="icon icon-shape bg-gradient-orange text-white rounded-circle shadow">
                              <i class="ni ni-chart-pie-35"></i>
                           </div>
                        </div>
                     </div>
                  </div>
               </div>
            </div>
            <div class="col-xl-4 col-md-6">
               <div class="card card-stats">
                  <div class="card-body">
                     <div class="row">
                        <div class="col">
                           <h5 class="card-title text-uppercase text-muted mb-0">Completed</h5>
                           <span class="h2 font-weight-bold mb-0">{{ coordinator_approved }}</span>
                        </div>
                        <div class="col-auto">
                           <div class="icon icon-shape bg-gradient-green text-white rounded-circle shadow">
                              <i class="ni ni-check-bold"></i>
                           </div>
                        </div>
                     </div>
                  </div>
               </div>
            </div>
         </div>
      </div>
   </div>
</div>
<!-- Charts Section -->
<div class="bg-card-color mt--6">
<!-- Year Selector -->
<div class="row">
   <div class="col-xl-12">
      <div class="card">
         <div class="card-body">
            <div class="year-selector d-flex align-items-center justify-content-between">
                <div class="btn-group">
                    <button id="calendarYearBtn" class="btn btn-primary active" onclick="switchYearType('calendar')">
                        Calendar Year
                    </button>
                    <button id="financialYearBtn" class="btn btn-outline-primary" onclick="switchYearType('financial')">
                        Financial Year
                    </button>
                </div>
                <div id="yearSelectContainer" class="ml-3">
                    <select id="yearSelect" class="form-control form-control-sm" onchange="updateChartData()">
                        {% for year in year_range %}
                        <option value="{{ year }}" {% if year == current_year %}selected{% endif %}>
                            {{ year }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
            </div>
         </div>
      </div>
   </div>
</div>
<!-- Monthly Charts Row -->
<div class="row">
   <div class="col-xl-8">
      <div class="card">
         <div class="card-header">
            <h6 class="text-uppercase text-muted ls-1 mb-1">Overview</h6>
            <h5 class="h3 mb-0">Monthly Submissions</h5>
         </div>
         <div class="card-body">
            <div class="chart">
               <canvas id="monthlyChart" class="chart-canvas"></canvas>
            </div>
         </div>
      </div>
   </div>
<!-- Replace the existing approval chart card with this -->
<!-- Replace the existing approval chart card with this updated version -->
<div class="col-xl-4">
    <div class="card bg-gradient-default shadow chart-card">
        <div class="card-header bg-transparent">
            <div class="row align-items-center">
                <div class="col">
                    <h6 class="text-uppercase text-light ls-1 mb-1">Status</h6>
                    <h5 class="h3 text-white mb-0">Approval Distribution</h5>
                </div>
            </div>
        </div>
        <div class="card-body">
            <div class="chart">
                <canvas id="approvalChart"></canvas>
            </div>
        </div>
    </div>
</div>
   <div class="col-xl-8">
      <div class="card bg-default">
         <div class="card-header bg-transparent">
            <div class="row align-items-center">
               <div class="col">
                  <h6 class="text-light text-uppercase ls-1 mb-1">Performance</h6>
                  <h2 class="text-white mb-0">Monthly Average</h2>
               </div>
            </div>
         </div>
         <div class="card-body">
            <div class="chart">
               <canvas id="monthlyAverageChart" class="chart-canvas"></canvas>
            </div>
         </div>
      </div>
   </div>
   <div class="col-xl-4">
      <div class="card">
         <div class="card-header bg-primary">
            <h4 class="text-white mb-0">
               <i class="fas fa-download mr-2"></i> Download Graph
            </h4>
         </div>
         <div class="card-body">
            <div class="list-group list-group-flush text-center">
                
               <a href="#" class="list-group-item list-group-item-action" onclick="downloadChartData('monthlyChart')">
               Monthly Submissions
               </a>
               <a href="#" class="list-group-item list-group-item-action" onclick="downloadChartData('approvalChart')">
               Approval Distribution
               </a>
               <a href="#" class="list-group-item list-group-item-action" onclick="downloadChartData('monthlyAverageChart')">
               Monthly Average
               </a>
               <a href="#" class="list-group-item list-group-item-action" onclick="downloadChartData('sheetsPerEmployeeChart')">
               Sheets Per Employee
               </a>
               <a href="#" class="list-group-item list-group-item-action" onclick="downloadChartData('yearlyPerformanceChart')">
               Yearly Performance
               </a>
            </div>
         </div>
      </div>
   </div>
   <div class="row">
      <!-- Sheets Per Employee -->
      <div class="col-xl-6">
         <div class="card">
            <div class="card-header bg-transparent">
               <div class="row align-items-center">
                  <div class="col">
                     <h6 class="text-uppercase text-muted ls-1 mb-1">Statistics</h6>
                     <h5 class="h3 mb-0">Sheets Per Employee</h5>
                  </div>
               </div>
            </div>
            <div class="card-body">
               <div class="chart">
                  <canvas id="sheetsPerEmployeeChart" class="chart-canvas"></canvas>
               </div>
            </div>
         </div>
      </div>
      <!-- Yearly Performance -->
      <div class="col-xl-6">
         <div class="card">
            <div class="card-header bg-transparent">
               <div class="row align-items-center">
                  <div class="col">
                     <h6 class="text-uppercase text-muted ls-1 mb-1">Overview</h6>
                     <h5 class="h3 mb-0">Yearly Performance</h5>
                  </div>
               </div>
            </div>
            <div class="card-body">
               <div class="chart">
                  <canvas id="yearlyPerformanceChart" class="chart-canvas"></canvas>
               </div>
            </div>
         </div>
      </div>
   </div>
</div>
<!-- Replace the existing Employee Stats Modal -->
<div class="modal fade" id="employeeStatsModal" tabindex="-1" aria-labelledby="employeeStatsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
       <div class="modal-content">
          <div class="modal-header">
             <h5 class="modal-title" id="employeeStatsModalLabel">Employee Statistics</h5>
             <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
             <div class="table-responsive">
                <table class="table align-items-center">
                  <thead class="thead-light">
                     <tr>
                        <th>Employee</th>
                        <th>Department</th>
                        <th>Total Submissions</th>
                        <th>Completed</th>
                        <th>Pending Approval</th>
                     </tr>
                  </thead>
                  <tbody>
                     {% for stat in employee_stats %}
                     <tr>
                        <td>{{ stat.username }}</td>
                        <td>{{ stat.department }}</td>
                        <td>{{ stat.total_submissions }}</td>
                        <td>{{ stat.approved }}</td>
                        <td>{{ stat.pending }}</td>
                     </tr>
                     {% endfor %}
                  </tbody>
               </table>
            </div>
         </div>
      </div>
   </div>
</div>
<!-- Replace the existing Target Achievers Modal -->
<div class="modal fade" id="targetAchieversModal" tabindex="-1" aria-labelledby="targetAchieversModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
       <div class="modal-content">
          <div class="modal-header">
             <h5 class="modal-title" id="targetAchieversModalLabel">Target Achievers</h5>
             <div class="ml-auto">
                <select id="targetYear" class="form-control form-control-sm d-inline-block" style="width: auto;">
               {% for year in year_range %}
               <option value="{{ year }}" {% if year == current_year %}selected{% endif %}>
               {{ year }}
               </option>
               {% endfor %}
               </select>
               <select id="targetMonth" class="form-control form-control-sm d-inline-block ml-2" style="width: auto;">
                <option value="1">January</option>
                <option value="2">February</option>
                <option value="3">March</option>
                <option value="4">April</option>
                <option value="5">May</option>
                <option value="6">June</option>
                <option value="7">July</option>
                <option value="8">August</option>
                <option value="9">September</option>
                <option value="10">October</option>
                <option value="11">November</option>
                <option value="12">December</option>
            </select>
            </div>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            <span aria-hidden="true">&times;</span>
            </button>
         </div>
         <div class="modal-body">
            <div class="table-responsive">
               <table class="table align-items-center">
                  <thead class="thead-light">
                     <tr>
                        <th>Sl. No</th>
                        <th>Department</th>
                        <th>Area Leader (HOD)</th>
                        <th>Kaizen Coordinator</th>
                        <th>Monthly Target</th>
                        <th>Completed</th>
                        <th>Achievement Rate</th>
                     </tr>
                  </thead>
                  <tbody id="targetAchieversBody"></tbody>
               </table>
            </div>
         </div>
      </div>
   </div>
</div>
{% block javascripts %}
{{ block.super }}
<script src="https://cdn.jsdelivr.net/npm/chart.js@2.9.4/dist/Chart.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@0.7.0"></script>
<script src="https://unpkg.com/exceljs/dist/exceljs.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
<script>
   document.addEventListener('DOMContentLoaded', function() {
       // Get initial data from template context
       const initialData = {
           months: JSON.parse('{{ months|safe }}'),
           submissions: JSON.parse('{{ monthly_submissions|safe }}'),
           completions: JSON.parse('{{ monthly_completions|safe }}'),
           academicYears: JSON.parse('{{ academic_years|safe }}'),
           yearlyAverages: JSON.parse('{{ academic_year_counts|safe }}'),
           completed: '{{ completed_count }}',
           hodPending: '{{ hod_pending_count }}',
           coordinatorPending: '{{ coordinator_pending_count }}',
           financePending: '{{ finance_pending_count }}',
           currentMonth: '{{ current_month }}'
       };
   
       // Store chart references globally
       window.monthlyChart = null;
   
       // Initialize charts
       initCharts(initialData);
   });
   // Store chart references globally
   let charts = {
       monthlyChart: null,
       approvalChart: null,
       monthlyAverageChart: null,
       sheetsPerEmployeeChart: null,
       yearlyPerformanceChart: null
   };
   // Chart configuration
   const chartConfig = {
       monthlySubmissions: {
           type: 'bar',
           options: {
               responsive: true,
               maintainAspectRatio: false,
               scales: {
                   yAxes: [{
                       ticks: {
                           beginAtZero: true
                       }
                   }]
               },
               tooltips: {
                   mode: 'index',
                   intersect: false
               }
           }
       }
   };
   
   const approvalCtx = document.getElementById('approvalChart').getContext('2d');
// Update the approvalChart configuration
charts.approvalChart = new Chart(approvalCtx, {
    type: 'pie',
    data: {
        labels: ['Completed', 'HOD Approval Pending', 'Coordinator Approval Pending', 'Finance Approval Pending'],
        datasets: [{
            data: [
                '{{ completed_count }}',
                '{{ hod_pending_count }}',
                '{{ coordinator_pending_count }}',
                '{{ finance_pending_count }}'
            ],
            backgroundColor: ['#2dce89', '#fb6340', '#5e72e4', '#f5365c'],
            borderWidth: 0
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        layout: {
            padding: {
                top: 20,
                bottom: 60,
                left: 20,
                right: 20
            }
        },
        legend: {
            display: true,
            position: 'bottom',
            align: 'center',
            labels: {
                fontColor: '#fff',
                fontSize: 11,
                padding: 15,
                boxWidth: 12,
                usePointStyle: true
            }
        },
        tooltips: {
            enabled: true,
            callbacks: {
                label: function(tooltipItem, data) {
                    const dataset = data.datasets[tooltipItem.datasetIndex];
                    const total = dataset.data.reduce((acc, curr) => acc + Number(curr), 0);
                    const value = dataset.data[tooltipItem.index];
                    const percentage = ((value * 100) / total).toFixed(1);
                    return `${data.labels[tooltipItem.index]}: ${value} (${percentage}%)`;
                }
            }
        }
    }
});
   
   // Monthly Averages Chart
   const avgCtx = document.getElementById('monthlyAverageChart').getContext('2d');
   const monthlyAverages = JSON.parse('{{ monthly_averages|safe }}');
   
   charts.monthlyAverageChart = new Chart(avgCtx, {
       type: 'bar',
       data: {
           labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 
                   'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'],
           datasets: [
               {
                   label: 'Monthly Average',
                   data: monthlyAverages,
                   backgroundColor: '#5e72e4',
                   datalabels: {
                       anchor: 'end',
                       align: 'end',
                       formatter: function(value) {
                           return value.toFixed(2);
                       },
                       font: {
                           weight: 'bold'
                       }
                   }
               },
               {
                   label: 'Trend',
                   data: monthlyAverages,
                   type: 'line',
                   fill: false,
                   borderColor: '#2dce89',
                   tension: 0.4,
                   pointRadius: 0,
                   datalabels: {
                       display: false
                   }
               }
           ]
       },
       options: {
           responsive: true,
           maintainAspectRatio: false,
           plugins: {
               datalabels: {
                   display: function(context) {
                       return context.dataset.type !== 'line';
                   }
               }
           },
           scales: {
               yAxes: [{
                   ticks: {
                       beginAtZero: true,
                       suggestedMax: Math.max(...monthlyAverages) + 1
                   }
               }]
           }
       }
   });
   
   
   // Sheets Per Employee Chart
   const sheetsPerEmployeeCtx = document.getElementById('sheetsPerEmployeeChart').getContext('2d');
   const monthlyCompletions = JSON.parse('{{ monthly_completions|safe }}');
   const totalEmployees = '{{ total_employees }}';
   
   const sheetsPerEmployee = monthlyCompletions.map(completions => 
       totalEmployees > 0 ? (completions / totalEmployees).toFixed(2) : 0
   );
   
   charts.sheetsPerEmployeeChart = new Chart(sheetsPerEmployeeCtx, {
       type: 'bar',
       data: {
           labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 
                   'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'],
           datasets: [{
               label: 'Sheets Per Employee',
               data: sheetsPerEmployee,
               backgroundColor: '#5e72e4',
               borderColor: '#5e72e4',
               borderWidth: 1,
               datalabels: {
                   anchor: 'end',
                   align: 'top',
                   formatter: Math.round,
                   font: {
                       weight: 'bold'
                   },
                   padding: {
                       top: 10
                   }
               }
           }, {
               label: 'Target',
               data: Array(12).fill(1),
               type: 'line',
               borderColor: '#2dce89',
               borderWidth: 2,
               fill: false,
               pointRadius: 0,
               datalabels: {
                   display: false
               }
           }]
       },
       options: {
           responsive: true,
           maintainAspectRatio: false,
           plugins: {
               datalabels: {
                   display: function(context) {
                       return context.dataset.type !== 'line';
                   }
               }
           },
           scales: {
               yAxes: [{
                   ticks: {
                       beginAtZero: true,
                       suggestedMax: Math.max(...sheetsPerEmployee.map(Number)) + 1
                   }
               }]
           }
       }
   });
   
   // Yearly Performance Chart
   const currentMonth = parseInt('{{ current_month }}');
   const currentYear = new Date().getFullYear();
   
// Replace the calculateYearlyAverages function with this updated version
function calculateYearlyAverages() {
    console.log('Calculating Yearly Averages');
    
    // Get completions data
    const completions = JSON.parse('{{ monthly_completions|safe }}');
    console.log('Monthly Completions:', completions);
    
    const currentMonth = parseInt('{{ current_month }}');
    const currentYear = parseInt('{{ current_year }}');
    
    console.log('Current Month:', currentMonth);
    console.log('Current Year:', currentYear);

    // Determine academic year (April to March)
    const currentAcademicYear = currentMonth >= 4 ? currentYear : currentYear - 1;
    console.log('Current Academic Year:', currentAcademicYear);

    // Calculate sum and count for the academic year so far
    let sum = 0;
    let count = 0;
    
    // Calculate which months to include based on academic year
    const startMonth = 3; // April is index 3
    const monthsToInclude = currentMonth >= 4 ? 
        currentMonth - 4 + 1 : // If we're after April, count months since April
        currentMonth + 9; // If we're before April, count from April last year
    
    console.log('Months to include:', monthsToInclude);

    // Sum up the completions for included months
    for (let i = 0; i < monthsToInclude; i++) {
        const monthIndex = (startMonth + i) % 12;
        const value = completions[monthIndex] || 0;
        sum += value;
        count++;
        console.log(`Month ${monthIndex + 1}: Value = ${value}, Sum = ${sum}, Count = ${count}`);
    }

    // Calculate average
    const yearlyAverage = count > 0 ? sum / count : 0;
    console.log('Yearly Average:', yearlyAverage);

    return {
        data: [yearlyAverage],
        labels: [`${currentYear}`]
    };
}

// Update the chart initialization
const yearlyCtx = document.getElementById('yearlyPerformanceChart').getContext('2d');
const { data: yearlyAverages, labels: yearLabels } = calculateYearlyAverages();

async function initializeYearlyPerformanceChart() {
    const yearlyCtx = document.getElementById('yearlyPerformanceChart').getContext('2d');
    
    try {
        const currentDate = new Date();
        const currentMonth = currentDate.getMonth(); // 0-11
        const currentYear = currentDate.getFullYear();

        // Get monthly completions
        const monthlyCompletions = JSON.parse('{{ monthly_completions|safe }}');
        
        // Calculate averages based on year type
        let yearlyData = [];
        let yearLabels = [];
        
        if (currentYearType === 'calendar') {
            // For calendar year, just show the current year
            let sum = 0;
            let count = 0;
            
            // Only count months up to current month
            for (let i = 0; i <= currentMonth; i++) {
                if (monthlyCompletions[i]) {
                    sum += monthlyCompletions[i];
                    count++;
                }
            }
            
            if (count > 0) {
                yearlyData.push(sum / count);
                yearLabels.push(currentYear.toString());
            }
        } else {
            // For financial year view
            if (currentMonth === 2) { // March
                // Calculate for both FY 2024-25 and 2025-26
                let sum2024_25 = 0;
                let count2024_25 = 0;
                
                // April to December 2024
                for (let i = 3; i < 12; i++) {
                    if (monthlyCompletions[i]) {
                        sum2024_25 += monthlyCompletions[i];
                        count2024_25++;
                    }
                }
                
                // January and February 2025
                for (let i = 0; i < 2; i++) {
                    if (monthlyCompletions[i]) {
                        sum2024_25 += monthlyCompletions[i];
                        count2024_25++;
                    }
                }
                
                // March 2025 (new financial year)
                const marchValue = monthlyCompletions[2] || 0;
                
                if (count2024_25 > 0) {
                    yearlyData.push(sum2024_25 / count2024_25);
                    yearLabels.push(`FY ${currentYear-1}-${currentYear.toString().slice(-2)}`);
                }
                
                if (marchValue > 0) {
                    yearlyData.push(marchValue);
                    yearLabels.push(`FY ${currentYear}-${(currentYear+1).toString().slice(-2)}`);
                }
            }
        }

        // Destroy existing chart if it exists
        if (charts.yearlyPerformanceChart) {
            charts.yearlyPerformanceChart.destroy();
        }
// Update the yearlyPerformanceChart configuration
charts.yearlyPerformanceChart = new Chart(yearlyCtx, {
    type: 'bar',
    data: {
        labels: yearLabels,
        datasets: [{
            label: 'Average Kaizens per Month',
            data: yearlyData,
            backgroundColor: '#5e72e4',
            borderColor: '#5e72e4',
            borderWidth: 1,
            barThickness: 60,  // Fixed bar width in pixels
            maxBarThickness: 60,
            categoryPercentage: 0.8,
            barPercentage: 0.9,
            datalabels: {
                anchor: 'end',
                align: 'end',
                formatter: value => value.toFixed(2),
                font: { weight: 'bold' }
            }
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        height: 400,
        scales: {
            y: {
                beginAtZero: true,
                min: 0
            }
        },
        layout: {
            padding: {
                left: 20,
                right: 20,
                top: 20,
                bottom: 20
            }
        }
    }
});

    } catch (error) {
        console.error('Error initializing yearly performance chart:', error);
    }
}



   // Calculate trend line (if we have more than one point)
    // Add debugging to trend line calculation
    function calculateTrendLine(data) {
        console.log('Calculating trend line for data:', data);
        
        if (data.length <= 1) {
            console.log('Insufficient data points for trend line');
            return data;
        }
       const n = data.length;
       const coords = data.map((y, x) => ({ x, y: Math.max(0, y) }));
       
       const sumX = coords.reduce((sum, p) => sum + p.x, 0);
       const sumY = coords.reduce((sum, p) => sum + p.y, 0);
       const sumXY = coords.reduce((sum, p) => sum + (p.x * p.y), 0);
       const sumXX = coords.reduce((sum, p) => sum + (p.x * p.x), 0);
       
       const slope = (n * sumXY - sumX * sumY) / (n * sumXX - sumX * sumX);
       const intercept = Math.max(0, (sumY - slope * sumX) / n);
       
       return data.map((_, x) => Math.max(0, slope * x + intercept));
   }
   
   const trendLineData = calculateTrendLine(yearlyAverages);
   
   charts.yearlyPerformanceChart = new Chart(yearlyCtx, {
       type: 'bar',
       data: {
           labels: yearLabels,
           datasets: [
               {
                   label: 'Average Kaizens per Month',
                   data: yearlyAverages,
                   backgroundColor: '#5e72e4',
                   borderColor: '#5e72e4',
                   borderWidth: 1,
                   datalabels: {
                       anchor: 'end',
                       align: 'end',
                       formatter: function(value) {
                           return value.toFixed(2);
                       },
                       font: {
                           weight: 'bold'
                       }
                   }
               },
               {
                   label: 'Trend',
                   data: trendLineData,
                   type: 'line',
                   fill: false,
                   borderColor: '#2dce89',
                   tension: 0.4,
                   pointRadius: 0,
                   datalabels: {
                       display: false
                   }
               }
           ]
       },
       options: {
           responsive: true,
           maintainAspectRatio: false,
           scales: {
               y: {
                   beginAtZero: true,
                   min: 0,
                   grid: {
                       drawBorder: false
                   },
                   suggestedMax: Math.max(...yearlyAverages) + 1
               },
               x: {
                   grid: {
                       drawBorder: false
                   }
               }
           },
           plugins: {
               legend: {
                   position: 'bottom'
               },
               tooltip: {
                   callbacks: {
                       label: function(context) {
                           if (context.dataset.type === 'line') {
                               return `Trend: ${context.parsed.y.toFixed(2)}`;
                           }
                           return `Average: ${context.parsed.y.toFixed(2)}`;
                       }
                   }
               }
           }
       }
   });
   
   // Monthly Submissions Chart
   const monthlyCtx = document.getElementById('monthlyChart').getContext('2d');
   charts.monthlyChart = new Chart(monthlyCtx, {
       type: 'bar',
       data: {
           labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 
                   'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'],
           datasets: [{
               label: 'Submitted',
               data: JSON.parse('{{ monthly_submissions|safe }}'),
               backgroundColor: '#5e72e4',
               datalabels: {
                   anchor: 'end',
                   align: 'top',
                   formatter: Math.round,
                   font: {
                       weight: 'bold'
                   },
                   padding: {
                       top: 10
                   }
               }
           }, {
               label: 'Completed',
               data: JSON.parse('{{ monthly_completions|safe }}'),
               backgroundColor: '#2dce89',
               datalabels: {
                   anchor: 'end',
                   align: 'top',
                   formatter: Math.round,
                   font: {
                       weight: 'bold'
                   },
                   padding: {
                       top: 10
                   }
               }
           }]
       },
       options: {
           responsive: true,
           maintainAspectRatio: false,
           plugins: {
               datalabels: {
                   display: function(context) {
                       return context.dataset.type !== 'line';
                   }
               }
           },
           scales: {
               yAxes: [{
                   ticks: {
                       beginAtZero: true,
                       suggestedMax: Math.max(...JSON.parse('{{ monthly_submissions|safe }}'), ...JSON.parse('{{ monthly_completions|safe }}')) + 10
                   }
               }]
           }
       }
   });
   
   function calculateMonthlyAverages(completions, yearType = currentYearType) {
    if (!Array.isArray(completions) || completions.length === 0) {
        return Array(12).fill(0);
    }
    
    const currentDate = new Date();
    const currentMonth = currentDate.getMonth(); // 0-11
    const currentYear = currentDate.getFullYear();
    const selectedYear = parseInt(document.getElementById('yearSelect').value);
    
    let cumulative = 0;
    let monthCount = 0;
    
    return completions.map((value, index) => {
        if (yearType === 'financial') {
            // For financial year view (May-Apr)
            const isCurrentFinancialYear = selectedYear === currentYear;
            
            if (isCurrentFinancialYear) {
                // For current financial year
                if (index >= 11) {
                    // Index 11 represents Apr of next year
                    return 0;
                }
                
                // Convert index to actual month (0-11)
                const actualMonth = (index + 4) % 12; // Start from May
                if (actualMonth > currentMonth) {
                    // Future month in current financial year
                    return 0;
                }
            } else if (selectedYear > currentYear) {
                // Future year - show no data
                return 0;
            }
            // Past years - show all data
        } else {
            // Calendar year logic
            if (selectedYear === currentYear && index > currentMonth) {
                return 0;
            }
        }

        // Calculate running average for valid months
        if (value !== null && value !== undefined) {
            cumulative += value;
            monthCount++;
        }
        
        return monthCount > 0 ? Number((cumulative / monthCount).toFixed(2)) : 0;
    });
}

// Add to your existing JavaScript
let currentYearType = 'calendar';

// Add debug logs in updateChartData
function updateChartData(yearType = currentYearType) {
    const selectedYear = document.getElementById('yearSelect').value;
    
    console.log('Updating chart data:');
    console.log('Year Type:', yearType);
    console.log('Selected Year:', selectedYear);
    
    fetch(`/get-yearly-data/${selectedYear}/?year_type=${yearType}`)
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                console.error('Error:', data.error);
                return;
            }

            console.log('Received data:', data);
            
            // Set month labels based on year type
            const labels = getMonthLabels(yearType);
            console.log('Using month labels:', labels);

            updateAllCharts(data, labels, yearType);
        })
        .catch(error => {
            console.error('Error updating charts:', error);
        });
}

// Update the updateAllCharts function
function updateAllCharts(data, labels, yearType) {
    // Monthly Submissions Chart
    if (charts.monthlyChart) {
        charts.monthlyChart.data.labels = labels;
        charts.monthlyChart.data.datasets[0].data = data.submissions;
        charts.monthlyChart.data.datasets[1].data = data.completions;
        charts.monthlyChart.update();
    }

    // Monthly Average Chart
    if (charts.monthlyAverageChart) {
        const monthlyAverages = calculateMonthlyAverages(data.completions, yearType);
        charts.monthlyAverageChart.data.labels = labels;
        charts.monthlyAverageChart.data.datasets[0].data = monthlyAverages;
        charts.monthlyAverageChart.data.datasets[1].data = monthlyAverages;
        charts.monthlyAverageChart.update();
    }

    // Sheets Per Employee Chart
    if (charts.sheetsPerEmployeeChart) {
        const sheetsPerEmployee = data.completions.map(count => 
            (totalEmployees > 0 ? (count / totalEmployees) : 0).toFixed(2)
        );
        charts.sheetsPerEmployeeChart.data.labels = labels;
        charts.sheetsPerEmployeeChart.data.datasets[0].data = sheetsPerEmployee;
        charts.sheetsPerEmployeeChart.update();
    }

    // Approval Chart
    if (charts.approvalChart) {
        const totalSubmitted = data.submissions.reduce((a, b) => a + b, 0);
        const totalCompleted = data.completions.reduce((a, b) => a + b, 0);
        const pending = Math.max(0, totalSubmitted - totalCompleted);
        
        charts.approvalChart.data.datasets[0].data = [
            totalCompleted,
            pending,
            data.coordinator_pending || 0,
            data.finance_pending || 0
        ];
        charts.approvalChart.update();
    }
}

function switchYearType(yearType) {
    currentYearType = yearType;
    
    const calendarBtn = document.getElementById('calendarYearBtn');
    const financialBtn = document.getElementById('financialYearBtn');
    const yearSelect = document.getElementById('yearSelect');
    
    yearSelect.innerHTML = '';
    
    const currentDate = new Date();
    const currentYear = currentDate.getFullYear();
    const currentMonth = currentDate.getMonth() + 1; // 1-12
    
    if (yearType === 'calendar') {
        calendarBtn.classList.add('active');
        financialBtn.classList.remove('active');
        
        // Add calendar year options
        for(let year = currentYear; year >= currentYear - 4; year--) {
            const option = new Option(year.toString(), year);
            yearSelect.add(option);
        }
    } else {
        calendarBtn.classList.remove('active');
        financialBtn.classList.add('active');
        
        // For financial year (Apr-Mar)
        const currentFY = currentMonth >= 4 ? currentYear : currentYear - 1;
        
        // Add financial year options
        for(let year = currentFY; year >= currentFY - 4; year--) {
            const option = new Option(
                `FY ${year}-${(year + 1).toString().slice(-2)}`, 
                year
            );
            yearSelect.add(option);
        }
    }

    updateChartData(yearType);
    initializeYearlyPerformanceChart();
}
   // Helper function to get chart title
   function getChartTitle(chartId) {
       switch(chartId) {
           case 'monthlyChart':
               return 'Monthly Submissions';
           case 'approvalChart':
               return 'Approval Distribution';
           case 'monthlyAverageChart':
               return 'Monthly Average';
           case 'sheetsPerEmployeeChart':
               return 'Sheets Per Employee';
           case 'yearlyPerformanceChart':
               return 'Yearly Performance';
           default:
               return 'Chart Data';
       }
   }
   // Update the initCharts function to pass year type
function initCharts(data) {
    // Initialize charts with current year type
    updateAllCharts({
        submissions: data.submissions,
        completions: data.completions
    }, getMonthLabels(currentYearType), currentYearType);
}

// Helper function to get month labels
function getMonthLabels(yearType) {
    return yearType === 'calendar' ?
        ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'] :
        ['Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec', 'Jan', 'Feb', 'Mar'];
}
// Replace the showEmployeeStats function
function showEmployeeStats() {
    const modal = new bootstrap.Modal(document.getElementById('employeeStatsModal'), {
        backdrop: 'static',
        keyboard: false
    });
    modal.show();
}

   
// Replace the showTargetAchievers function
function showTargetAchievers() {
    const now = new Date();
    const yearSelect = document.getElementById('targetYear');
    const monthSelect = document.getElementById('targetMonth');
    
    yearSelect.value = now.getFullYear();
    monthSelect.value = now.getMonth() + 1;
    
    const modal = new bootstrap.Modal(document.getElementById('targetAchieversModal'));
    modal.show();
    
    loadTargetAchievers();
}
   
   async function loadTargetAchievers() {
    const tbody = document.getElementById('targetAchieversBody');
    tbody.innerHTML = '';

    try {
        const year = document.getElementById('targetYear').value;
        const month = document.getElementById('targetMonth').value;
        
        console.log('Loading data for:', year, month); // Debug log

        const response = await fetch(`/get-department-data/${year}/${month}/`);
        const data = await response.json();

        if (!data.success) {
            throw new Error(data.error);
        }

        console.log('Received data:', data); // Debug log

        // Clear existing buttons if any
        const existingButtons = document.querySelector('.target-achievers-buttons');
        if (existingButtons) existingButtons.remove();

        // Add buttons below the table
        const buttonContainer = document.createElement('div');
        buttonContainer.className = 'mt-3 text-right target-achievers-buttons';
        buttonContainer.innerHTML = `
            <button class="btn btn-primary mr-2" onclick="saveCoordinators()">Save</button>
            <button class="btn btn-secondary" onclick="downloadTargetAchievers()">Download</button>
        `;
        document.querySelector('#targetAchieversModal .modal-body').appendChild(buttonContainer);

        // Update table header
        const headerRow = document.querySelector('#targetAchieversModal thead tr');
        headerRow.innerHTML = `
            <th>Sl. No</th>
            <th>Area</th>
            <th>Area Leader (HOD)</th>
            <th>Kaizen Coordinator</th>
            <th>Monthly Target</th>
            <th>Completed This Month</th>
            <th>Total Completed</th>
            <th>Achievement Rate</th>
        `;

        // Inside loadTargetAchievers function, update the forEach loop:
        data.departments
            .sort((a, b) => {
                // Sort by achievement rate
                const aRate = a.achievement_rate || 0;
                const bRate = b.achievement_rate || 0;
                return bRate - aRate;
            })
            .forEach((dept, index) => {
                console.log(`Processing department:`, dept); // Debug log
                const achievementRate = dept.achievement_rate.toFixed(2);
                tbody.insertRow().innerHTML = `
                    <td>${index + 1}</td>
                    <td>${dept.name}</td>
                    <td>${dept.hod_name}</td>
                    <td>
                        <input type="text" 
                            class="form-control coordinator-input" 
                            data-department="${dept.name}"
                            value="${dept.kaizen_coordinator || ''}"
                        />
                    </td>
                    <td>${dept.monthly_target || 0}</td>
                    <td>${dept.completed || 0}</td>
                    <td>${dept.total_completed || 0}</td>
                    <td>${achievementRate}%</td>
                `;
            });

    } catch (error) {
        console.error('Error loading target achievers:', error);
        alert('Error loading data: ' + error.message);
    }
}

// Update the event listeners
document.addEventListener('DOMContentLoaded', function() {
    // Initialize month selector
    const monthSelect = document.getElementById('targetMonth');
    if (monthSelect) {
        // Set current month as default
        const currentDate = new Date();
        monthSelect.value = (currentDate.getMonth() + 1).toString();
        
        // Add event listeners
        monthSelect.addEventListener('change', function() {
            console.log('Month changed to:', this.value); // Debug log
            loadTargetAchievers();
        });
    }

    const yearSelect = document.getElementById('targetYear');
    if (yearSelect) {
        yearSelect.addEventListener('change', function() {
            console.log('Year changed to:', this.value); // Debug log
            loadTargetAchievers();
        });
    }
});

// Also add the month options in your HTML
   
   // Keep existing save and download functions
   async function saveCoordinators() {
       const inputs = document.querySelectorAll('.coordinator-input');
       const data = {};
   
       inputs.forEach(input => {
           const department = input.dataset.department;
           const coordinatorName = input.value.trim();
           data[department] = coordinatorName;
       });
   
       try {
           const response = await fetch('{% url "save_kaizen_coordinators" %}', {
               method: 'POST',
               headers: {
                   'Content-Type': 'application/json',
                   'X-CSRFToken': '{{ csrf_token }}'
               },
               body: JSON.stringify(data)
           });
   
           const result = await response.json();
           if (result.success) {
               alert('Kaizen Coordinators updated successfully');
           } else {
               alert('Error updating coordinators: ' + result.error);
           }
       } catch (error) {
           console.error('Error saving coordinators:', error);
           alert('Error saving coordinators');
       }
   }
   
   async function downloadTargetAchievers() {
       try {
           const workbook = new ExcelJS.Workbook();
           const year = document.getElementById('targetYear').value;
           const month = document.getElementById('targetMonth').value;
           
           // Get month name
           const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
               'July', 'August', 'September', 'October', 'November', 'December'];
           const monthName = monthNames[parseInt(month) - 1];
           
           // Fetch template
           const response = await fetch('{% url "get_excel_template" "target achievers.xlsx" %}');
           if (!response.ok) throw new Error('Failed to fetch template');
           const templateBuffer = await response.arrayBuffer();
           
           await workbook.xlsx.load(templateBuffer);
           const worksheet = workbook.getWorksheet(1);
           
           if (!worksheet) {
               throw new Error('Worksheet not found in template');
           }
   
           // Write header data
           worksheet.getCell('M2').value = parseInt(year);
           worksheet.getCell('K2').value = parseInt(month);
           worksheet.getCell('B5').value = `Kaizen Target Achievers for ${monthName} ${year}`;
           
           // Get table data
           const tableRows = document.querySelectorAll('#targetAchieversBody tr');
           
           // Write data rows
           tableRows.forEach((row, index) => {
               const columns = row.querySelectorAll('td');
               const rowNum = index + 8; // Start from row 8
               
               // Sl No
               worksheet.getCell(`B${rowNum}`).value = parseInt(columns[0].textContent);
               
               // Department
               worksheet.getCell(`C${rowNum}`).value = columns[1].textContent;
               
               // Area Leader
               worksheet.getCell(`F${rowNum}`).value = columns[2].textContent;
               
               // Kaizen Coordinator
               worksheet.getCell(`H${rowNum}`).value = columns[3].querySelector('input').value;
               
               // Monthly Target
               worksheet.getCell(`K${rowNum}`).value = parseInt(columns[4].textContent);
               
               // Completed
               worksheet.getCell(`M${rowNum}`).value = parseInt(columns[5].textContent);
               
               // Kaizens per Employee
               worksheet.getCell(`O${rowNum}`).value = parseFloat(columns[6].textContent);
               worksheet.getCell(`O${rowNum}`).numFmt = '0.00';
           });
   
           const buffer = await workbook.xlsx.writeBuffer();
           const blob = new Blob([buffer], { 
               type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' 
           });
           saveAs(blob, `target_achievers_${monthName}_${year}.xlsx`);
   
       } catch (error) {
           console.error('Error generating Excel file:', error);
           alert(`Error generating Excel file: ${error.message}`);
       }
   }
   
   // Add this to your existing JavaScript
document.addEventListener('DOMContentLoaded', function() {
    // Update modal close handlers
    const modals = document.querySelectorAll('.modal');
    modals.forEach(modal => {
        modal.addEventListener('hidden.bs.modal', function() {
            // Clean up any necessary state
        });
    });
});
   // Add event listeners for the year and month selectors
   document.getElementById('targetYear').addEventListener('change', loadTargetAchievers);
   document.getElementById('targetMonth').addEventListener('change', loadTargetAchievers);
   
   async function saveCoordinators() {
       const inputs = document.querySelectorAll('.coordinator-input');
       const data = {};
   
       inputs.forEach(input => {
           const department = input.dataset.department;
           const coordinatorName = input.value.trim();
           data[department] = coordinatorName;
       });
   
       try {
           const response = await fetch('{% url "save_kaizen_coordinators" %}', {
               method: 'POST',
               headers: {
                   'Content-Type': 'application/json',
                   'X-CSRFToken': '{{ csrf_token }}'
               },
               body: JSON.stringify(data)
           });
   
           const result = await response.json();
           if (result.success) {
               alert('Kaizen Coordinators updated successfully');
           } else {
               alert('Error updating coordinators: ' + result.error);
           }
       } catch (error) {
           console.error('Error saving coordinators:', error);
           alert('Error saving coordinators');
       }
   }
   
   async function downloadChartData(chartId) {
       if (chartId === 'approvalChart') {
           try {
               const workbook = new ExcelJS.Workbook();
               const selectedYear = document.getElementById('yearSelect').value;
               
               // Fetch template
               const response = await fetch('{% url "get_excel_template" "total kaizen.xlsx" %}');
               if (!response.ok) throw new Error('Failed to fetch template');
               const templateBuffer = await response.arrayBuffer();
               
               await workbook.xlsx.load(templateBuffer);
               const worksheet = workbook.getWorksheet(1);
               
               if (!worksheet) {
                   throw new Error('Worksheet not found in template');
               }
   
               // Write data to specified cells
               worksheet.getCell('L1').value = parseInt(selectedYear);
               worksheet.getCell('N10').value = parseInt('{{ total_kaizens }}');
               worksheet.getCell('N11').value = parseInt('{{ completed_count }}');
               worksheet.getCell('N12').value = parseInt('{{ pending_approvals }}');
               worksheet.getCell('N14').value = parseInt('{{ hod_pending_count }}');
               worksheet.getCell('N16').value = parseInt('{{ coordinator_pending_count }}');
               worksheet.getCell('N18').value = parseInt('{{ finance_pending_count }}');
   
               // Add chart image
               const chart = charts[chartId];
               const imageId = workbook.addImage({
                   base64: chart.toBase64Image(),
                   extension: 'png',
               });
               
               worksheet.addImage(imageId, {
                   tl: { col: 2, row: 9 },
                   ext: { width: 500, height: 300 }
               });
   
               const buffer = await workbook.xlsx.writeBuffer();
               const blob = new Blob([buffer], { 
                   type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' 
               });
               saveAs(blob, `approval_distribution_${selectedYear}.xlsx`);
   
           } catch (error) {
               console.error('Error details:', error);
               alert(`Error generating Excel file: ${error.message}`);
           }
       }
   
       if (chartId === 'monthlyChart') {
           try {
               const workbook = new ExcelJS.Workbook();
               const selectedYear = document.getElementById('yearSelect').value;
               
               // Fetch template
               const response = await fetch('{% url "get_excel_template" "monthly submissions.xlsx" %}');
               if (!response.ok) throw new Error('Failed to fetch template');
               const templateBuffer = await response.arrayBuffer();
               
               await workbook.xlsx.load(templateBuffer);
               const worksheet = workbook.getWorksheet(1);
               
               if (!worksheet) {
                   throw new Error('Worksheet not found in template');
               }
   
               // Write data to specified cells
               const yearCell = worksheet.getCell('K1');
               yearCell.value = parseInt(selectedYear);
               yearCell.font = { name: 'Arial', size: 22, bold: true };
               
               const months = ['C', 'D', 'E', 'F', 'G', 'H', 'I', 'J', 'K', 'L', 'M', 'N'];
               const submissions = JSON.parse('{{ monthly_submissions|safe }}');
               const completions = JSON.parse('{{ monthly_completions|safe }}');
               
               months.forEach((col, index) => {
                   worksheet.getCell(`${col}8`).value = submissions[index];
                   worksheet.getCell(`${col}9}`).value = completions[index];
               });
   
               // Add chart image
               const chart = charts[chartId];
               const imageId = workbook.addImage({
                   base64: chart.toBase64Image(),
                   extension: 'png',
               });
               
               worksheet.addImage(imageId, {
                   tl: { col: 1, row: 11 },
                   ext: { width: 800, height: 450 }
               });
   
               const buffer = await workbook.xlsx.writeBuffer();
               const blob = new Blob([buffer], { 
                   type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' 
               });
               saveAs(blob, `monthly_submissions_${selectedYear}.xlsx`);
   
           } catch (error) {
               console.error('Error details:', error);
               alert(`Error generating Excel file: ${error.message}`);
           }
       }
   
       if (chartId === 'sheetsPerEmployeeChart') {
           try {
               const workbook = new ExcelJS.Workbook();
               const selectedYear = document.getElementById('yearSelect').value;
               
               // Fetch template
               const response = await fetch('{% url "get_excel_template" "per emp and monthly sub.xlsx" %}');
               if (!response.ok) throw new Error('Failed to fetch template');
               const templateBuffer = await response.arrayBuffer();
               
               await workbook.xlsx.load(templateBuffer);
               const worksheet = workbook.getWorksheet(1);
               
               if (!worksheet) {
                   throw new Error('Worksheet not found in template');
               }
   
               // Write data to specified cells
               const yearCell = worksheet.getCell('J2');
               yearCell.value = parseInt(selectedYear);
               
   
               // Add chart images
               const employeeChart = charts['monthlyChart'];
               const employeeImageId = workbook.addImage({
                   base64: employeeChart.toBase64Image(),
                   extension: 'png',
               });
               
               worksheet.addImage(employeeImageId, {
                   tl: { col: 1, row: 7 },
                   ext: { width: 475, height: 300 }
               });
   
               const perEmployeeChart = charts['sheetsPerEmployeeChart'];
               const perEmployeeImageId = workbook.addImage({
                   base64: perEmployeeChart.toBase64Image(),
                   extension: 'png',
               });
               
               worksheet.addImage(perEmployeeImageId, {
                   tl: { col: 8, row: 7 },
                   ext: { width: 475, height: 300 }
               });
   
               const buffer = await workbook.xlsx.writeBuffer();
               const blob = new Blob([buffer], { 
                   type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' 
               });
               saveAs(blob, `per_employee_sheet_${selectedYear}.xlsx`);
   
           } catch (error) {
               console.error('Error details:', error);
               alert(`Error generating Excel file: ${error.message}`);
           }
       }
       if (chartId === 'monthlyAverageChart') {
           try {
               const workbook = new ExcelJS.Workbook();
               const selectedYear = document.getElementById('yearSelect').value;
               
               // Fetch template
               const response = await fetch('{% url "get_excel_template" "monthly average.xlsx" %}');
               if (!response.ok) throw new Error('Failed to fetch template');
               const templateBuffer = await response.arrayBuffer();
               
               await workbook.xlsx.load(templateBuffer);
               const worksheet = workbook.getWorksheet(1);
               
               if (!worksheet) {
                   throw new Error('Worksheet not found in template');
               }
   
               // Write data to specified cells
               const yearCell = worksheet.getCell('K1');
               yearCell.value = parseInt(selectedYear);
               yearCell.font = { name: 'Arial', size: 22, bold: true };
               
               const months = ['C', 'D', 'E', 'F', 'G', 'H', 'I', 'J', 'K', 'L', 'M', 'N'];
               const monthlyAverages = JSON.parse('{{ monthly_averages|safe }}');
               
               months.forEach((col, index) => {
                   worksheet.getCell(`${col}8`).value = monthlyAverages[index];
               });
   
               // Add chart image
               const chart = charts[chartId];
               const imageId = workbook.addImage({
                   base64: chart.toBase64Image(),
                   extension: 'png',
               });
               
               worksheet.addImage(imageId, {
                   tl: { col: 1, row: 11 },
                   ext: { width: 800, height: 450 }
               });
   
               const buffer = await workbook.xlsx.writeBuffer();
               const blob = new Blob([buffer], { 
                   type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' 
               });
               saveAs(blob, `monthly_average_${selectedYear}.xlsx`);
   
           } catch (error) {
               console.error('Error details:', error);
               alert(`Error generating Excel file: ${error.message}`);
           }
       }
   
       if (chartId === 'yearlyPerformanceChart') {
       try {
           const workbook = new ExcelJS.Workbook();
           const selectedYear = document.getElementById('yearSelect').value;
           
           // Fetch template
           const response = await fetch('{% url "get_excel_template" "yearly average.xlsx" %}');
           if (!response.ok) throw new Error('Failed to fetch template');
           const templateBuffer = await response.arrayBuffer();
           
           await workbook.xlsx.load(templateBuffer);
           const worksheet = workbook.getWorksheet(1);
           
           if (!worksheet) {
               throw new Error('Worksheet not found in template');
           }
   
           // Write data to specified cells
           const yearCell = worksheet.getCell('K1');
           yearCell.value = parseInt(selectedYear);
           yearCell.font = { name: 'Arial', size: 22, bold: true };
           
           // Calculate current and previous academic years
           const currentAcademicYear = currentMonth >= 4 ? currentYear : currentYear - 1;
           const academicYears = [];
           const yearlyValues = [];
           
           // Generate last 4 academic years
           for(let i = 3; i >= 0; i--) {
               const year = currentAcademicYear - i;
               academicYears.push(`AY ${year}-${year + 1}`);
               // Only current year has data, rest are zero
               yearlyValues.push(i === 0 ? yearlyAverages[0] : 0);
           }
           
           // Column mapping for cells
           const columns = ['C', 'D', 'E', 'F'];
           
           // Plot academic years in row 3 and data in row 8
           columns.forEach((col, index) => {
               // Academic year headings in row 3
               worksheet.getCell(`${col}3`).value = academicYears[index];
               worksheet.getCell(`${col}3`).font = { bold: true };
               
               // Yearly averages in row 8
               worksheet.getCell(`${col}8`).value = yearlyValues[index];
               worksheet.getCell(`${col}8`).numFmt = '0.0000';
           });
   
           // Add chart image at B12
           const chart = charts[chartId];
           const imageId = workbook.addImage({
               base64: chart.toBase64Image(),
               extension: 'png',
           });
           
           worksheet.addImage(imageId, {
               tl: { col: 1, row: 11 },
               ext: { width: 800, height: 450 }
           });
   
           const buffer = await workbook.xlsx.writeBuffer();
           const blob = new Blob([buffer], { 
               type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' 
           });
           saveAs(blob, `yearly_average_${selectedYear}.xlsx`);
   
       } catch (error) {
           console.error('Error details:', error);
           alert(`Error generating Excel file: ${error.message}`);
       }
   }
   }
   
   
   // Table Search Function
   function setupTableSearch(inputId, tableId) {
       document.getElementById(inputId)?.addEventListener('keyup', function() {
           const searchText = this.value.toLowerCase();
           const rows = document.getElementById(tableId)?.getElementsByTagName('tr') || [];
           
           Array.from(rows).slice(1).forEach(row => {
               const text = Array.from(row.getElementsByTagName('td'))
                   .map(cell => cell.textContent.toLowerCase())
                   .join(' ');
               row.style.display = text.includes(searchText) ? '' : 'none';
           });
       });
   }



</script>
{% endblock javascripts %}
{% endblock content %}
