<!DOCTYPE html>
<html lang="en">
{% load custom_filters %}

   <head>
      <meta charset="UTF-8">
      <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
      <title>Employee Dashboard</title>
      {% load static %}
      <!-- Argon Core CSS -->
      <link rel="stylesheet" href="/static/assets/css/argon.css?v=1.2.0" type="text/css">
      <!-- Fonts -->
      <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,400,600,700">
      <!-- Icons -->
      <link rel="stylesheet" href="/static/assets/vendor/nucleo/css/nucleo.css" type="text/css">
      <link rel="stylesheet" href="/static/assets/vendor/@fortawesome/fontawesome-free/css/all.min.css" type="text/css">
      <!-- Custom CSS -->
      <style>
         .bg-default {
         background: 
         rgba(255, 255, 255, 0.8)!important;
         }
         .bg-card-color{
         background:  rgba(255, 248, 248, 0.6)!important;
         }
         .bg-gradient-default {
         background: 
         linear-gradient(135deg, transparent 25%, rgba(128, 0, 0, 0.15) 25%, 
         rgba(128, 0, 0, 0.15) 50%, transparent 50%, transparent 75%, 
         rgba(128, 0, 0, 0.15) 75%, rgba(128, 0, 0, 0.15)),
         linear-gradient(45deg, transparent 25%, rgba(128, 0, 0, 0.2) 25%, 
         rgba(128, 0, 0, 0.2) 50%, transparent 50%, transparent 75%, 
         rgba(128, 0, 0, 0.2) 75%, rgba(128, 0, 0, 0.2)) !important;
         background-size: 20px 20px;
         background-color: white;
         position: relative;
         height: 120px;
         margin-bottom: 30px;
         padding: 20px 0;
         }
         .thead-light {
         background: rgba(255, 242, 242, 0.1) !important;
         }
         .thead-light th {
         color: #333333 !important;
         border-color: rgba(128, 0, 0, 0.2) !important;
         }
         .main-content {
         background: white;
         }
         .btn-maroon {
         background-color: #800000 !important;
         border-color: #800000 !important;
         color: #ffffff !important;
         transition: all 0.3s ease;
         }
         .btn-maroon:hover {
         background-color: #008194 !important;
         border-color: #008194 !important;
         color: #ffffff !important;
         box-shadow: 0 4px 6px rgba(50, 50, 93, .11), 0 1px 3px rgba(0, 0, 0, .08);
         }
      </style>
   </head>
   <body class="bg-default">
      <!-- Main content -->
      <div class="main-content">
         <!-- Header -->
         <div class="bg-gradient-default pb-8 pt-5">
            <div class="container-fluid">
               <div class="header-body">
                  <div class="row">
                     <div class="col-xl-12">
                        <div class="card card-stats">
                           <div class="card-body d-flex justify-content-between align-items-center">
                              <h2 class="mb-0">Welcome, {{ request.user.username }}</h2>
                              <div>
                                 <button type="button" class="btn btn-maroon mr-3" data-toggle="modal" data-target="#profile-edit-modal">
                                     <i class="ni ni-single-02"></i> Edit Profile
                                 </button>
                                 <button type="button" class="btn btn-maroon mr-3" data-toggle="modal" data-target="#upload-modal">
                                     <i class="ni ni-cloud-upload-96"></i> Upload Kaizen Sheet Image
                                 </button>
                                 <button type="button" class="btn btn-maroon mr-3" data-toggle="modal" data-target="#edit-upload-modal">
                                     <i class="ni ni-settings"></i> Edit Uploaded Sheet
                                 </button>
                                 <a href="{% url 'logout' %}" class="btn btn-danger">
                                     <i class="ni ni-user-run"></i> Logout
                                 </a>
                             </div>
                          </div>
                        </div>
                     </div>
                  </div>
               </div>
            </div>
         </div>
         
         <!-- Update the Modal section -->
         <div class="modal fade" id="upload-modal" tabindex="-1" role="dialog" aria-labelledby="upload-modal-label" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered" role="document">
               <div class="modal-content">
                  <div class="modal-header">
                     <h5 class="modal-title" id="upload-modal-label">Upload Handwritten Kaizen Sheet</h5>
                     <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                     <span aria-hidden="true">&times;</span>
                     </button>
                  </div>
                  
                  <div class="modal-body">
                     <form id="handwritten-form" method="post" enctype="multipart/form-data">
                        {% csrf_token %}
                        <input type="hidden" name="form_type" value="handwritten">
                        <div class="form-group">
                           <label class="form-control-label" for="handwritten_title">Title</label>
                           <input type="text" id="handwritten_title" name="handwritten_title" class="form-control" required>
                        </div>
                        <div class="form-group">
                           <label class="form-control-label">Upload Sheet</label>
                           <div class="custom-file">
                              <input type="file" id="handwritten_sheet" name="handwritten_sheet" accept="image/*" required>
                           </div>
                        </div>
                        <div class="text-center">
                           <button type="button" onclick="uploadHandwrittenSheet()" class="btn btn-maroon">Submit</button>
                        </div>
                     </form>
                  </div>
               </div>
            </div>
         </div>
         <div class="modal fade" id="edit-upload-modal" tabindex="-1" role="dialog" aria-labelledby="edit-upload-modal-label" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="edit-upload-modal-label">Edit Uploaded Kaizen Sheet</h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div class="modal-body">
                        <form id="edit-handwritten-form" method="post" enctype="multipart/form-data">
                            {% csrf_token %}
                            <input type="hidden" name="form_type" value="edit_handwritten">
                            <div class="form-group">
                                <label class="form-control-label" for="edit_sheet_select">Select Sheet</label>
                                <select id="edit_sheet_select" class="form-control" required>
                                 <option value="">Select sheet to edit</option>
                                 {% for sheet in handwritten_sheets %}
                                     <option value="{{ sheet.id }}" 
                                             data-approved="{{ sheet.approval_status|is_approved }}">
                                         {{ sheet.title }}
                                     </option>
                                 {% endfor %}
                             </select>
                            </div>
                            <div class="form-group">
                                <label class="form-control-label" for="edit_handwritten_title">Title</label>
                                <input type="text" id="edit_handwritten_title" name="handwritten_title" class="form-control" required>
                            </div>
                            <div class="form-group">
                                <label class="form-control-label">Replace Sheet</label>
                                <div class="custom-file">
                                    <input type="file" id="edit_handwritten_sheet" name="handwritten_sheet" accept="image/*">
                                    <label class="custom-file-label" for="edit_handwritten_sheet">Choose file</label>
                                </div>
                                <small class="form-text text-muted">Leave empty to keep existing sheet</small>
                            </div>
                            <div class="text-center">
                                <button type="button" onclick="updateHandwrittenSheet()" class="btn btn-maroon">Update</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
        <div class="modal fade" id="profile-edit-modal" tabindex="-1" role="dialog" aria-labelledby="profile-edit-modal-label" aria-hidden="true">
         <div class="modal-dialog modal-dialog-centered" role="document">
             <div class="modal-content">
                 <div class="modal-header">
                     <h5 class="modal-title" id="profile-edit-modal-label">Edit Profile</h5>
                     <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                         <span aria-hidden="true">&times;</span>
                     </button>
                 </div>
                 <div class="modal-body">
                     <form id="profile-edit-form" method="post">
                         {% csrf_token %}
                         <div class="form-group">
                             <label class="form-control-label">Username</label>
                             <input type="text" id="edit_username" name="username" class="form-control" value="{{ request.user.username }}" required>
                         </div>
                         <div class="form-group">
                             <label class="form-control-label">New Password (leave blank to keep current)</label>
                             <input type="password" id="edit_password" name="password" class="form-control">
                             <small class="form-text text-muted">Password should be changed every 40 days for security.</small>
                         </div>
                         <div class="form-group">
                           <label class="form-control-label">Department</label>
                           <select id="edit_department" name="department" class="form-control" required>
                               {% for dept in department_choices %}
                                   <option value="{{ dept }}" {% if dept == request.active_profile.department %}selected{% endif %}>
                                       {{ dept }}
                                   </option>
                               {% endfor %}
                           </select>
                         </div>
                         <div class="text-center">
                             <button type="button" onclick="updateProfile()" class="btn btn-primary">Save Changes</button>
                             <button type="button" class="btn btn-danger" data-toggle="modal" data-target="#delete-account-modal">
                              Delete Account
                          </button>
                         </div>
                     </form>
                 </div>
             </div>
         </div>
     </div>
     <div class="modal fade" id="delete-account-modal" tabindex="-1" role="dialog">
      <div class="modal-dialog modal-dialog-centered" role="document">
          <div class="modal-content">
              <div class="modal-header">
                  <h5 class="modal-title">Delete Account</h5>
                  <button type="button" class="close" data-dismiss="modal">
                      <span>&times;</span>
                  </button>
              </div>
              <div class="modal-body">
                  <p>Are you sure you want to delete your account? This action cannot be undone.</p>
                  <p>You can create a new account later using the same employee ID and email.</p>
              </div>
              <div class="modal-footer">
                  <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                  <button type="button" class="btn btn-danger" onclick="deleteAccount()">Delete Account</button>
              </div>
          </div>
      </div>
  </div>
      </div>
      
      <!-- Main Form Card -->
      <div class="card bg-card-color shadow">
      <div class="card-header bg-white border-0">
         <h3 class="mb-0">Kaizen Sheet Submission</h3>
      </div>
      <div class="card-body">
      <form id="main-kaizen-form" method="post" enctype="multipart/form-data" onsubmit="return validateForm()">
         {% csrf_token %}
         <!-- Basic Information -->
         <div class="pl-lg-4">
            <h6 class="heading-small text-muted mb-4">Basic Information</h6>
            <div class="row">
               <div class="col-lg-6">
                  <div class="form-group">
                     <label class="form-control-label" for="id_title">Title</label>
                     <input type="text" id="id_title" name="title" class="form-control">
                  </div>
               </div>
               <div class="col-lg-6">
                  <div class="form-group">
                     <label class="form-control-label" for="area_grouping">Area</label>
                     <select class="form-control" id="area_grouping" name="area_grouping" required>
                         <option value="">Select Area</option>
                         {% for choice in area_grouping_choices %}
                             <option value="{{ choice.0 }}">{{ choice.1 }}</option>
                         {% endfor %}
                     </select>
                 </div>
               </div>
            </div>
            <!-- Team Section -->
            <div class="row">
               <div class="col-lg-6">
                  <div class="form-group">
                     <label class="form-control-label" for="id_team_member2_id">Team Member ID (support)</label>
                     <input type="number" id="id_team_member2_id" name="team_member2_id" class="form-control" placeholder="Enter team member's ID">
                  </div>
               </div>
               <div class="col-lg-6">
                  <div class="form-group">
                     <label class="form-control-label" for="id_team_member2">Team Member Name (support)</label>
                     <input type="text" id="id_team_member2" name="team_member2" class="form-control" placeholder="Enter team member's name">
                  </div>
               </div>
            </div>
            <!-- Date Section -->
            <div class="row">
               <div class="col-lg-6">
                  <div class="form-group">
                     <label class="form-control-label" for="id_start_date">Start Date</label>
                     <input type="date" id="id_start_date" name="start_date" class="form-control" required>
                  </div>
               </div>
               <div class="col-lg-6">
                  <div class="form-group">
                     <label class="form-control-label" for="id_end_date">End Date</label>
                     <input type="date" id="id_end_date" name="end_date" class="form-control" required>
                  </div>
               </div>
            </div>
         </div>
         <div class="pl-lg-4">
            <h6 class="heading-small text-muted mb-4">Project Details</h6>
            <!-- Problem Section -->
            <div class="row">
               <div class="col-lg-12">
                  <div class="form-group">
                     <label class="form-control-label" for="id_problem">Problem</label>
                     <textarea class="form-control" id="id_problem" name="problem" rows="3" required></textarea>
                  </div>
               </div>
            </div>
            <!-- Idea/Solution Section -->
            <div class="row">
               <div class="col-lg-12">
                  <div class="form-group">
                     <label class="form-control-label" for="id_idea_solved">Idea/Solution</label>
                     <textarea class="form-control" id="id_idea_solved" name="idea_solved" rows="3" required></textarea>
                  </div>
               </div>
            </div>
            <!-- Standardization Section -->
            <div class="row">
               <div class="col-lg-12">
                  <div class="form-group">
                     <label class="form-control-label" for="id_standardization">Standardization</label>
                     <textarea class="form-control" id="id_standardization" name="standardization" rows="3" required></textarea>
                     <div class="custom-file mt-3">
                        <input type="file" class="custom-file-input" id="id_standardization_file" 
                           name="standardization_file" accept=".pdf,.xlsx,.xls,.jpg,.jpeg,.png">
                        <label class="custom-file-label" for="id_standardization_file"></label>
                        <small class="form-text text-muted">Upload Image/Excel/PDF documentation</small>
                     </div>
                  </div>
               </div>
            </div>
            <!-- Deployment Section -->
            <div class="row">
               <div class="col-lg-12">
                  <div class="form-group">
                     <label class="form-control-label" for="id_deployment">Deployment Description</label>
                     <textarea class="form-control" id="id_deployment" name="deployment" rows="3" required></textarea>
                  </div>
               </div>
            </div>
         </div>
         <hr class="my-4">
         <!-- Horizontal Deployment Section -->
         <div class="pl-lg-4">
            <h6 class="heading-small text-muted mb-4">Deployable departments</h6>
            <div class="custom-control custom-checkbox mb-3">
               <input type="checkbox" 
                  class="custom-control-input" 
                  id="id_horizontal_deployment"
                  name="id_horizontal_deployment"
                  onclick="toggleHorizontalDeployment(this)">
               <label class="custom-control-label" for="id_horizontal_deployment">
               Horizontal Deployment
               </label>
            </div>
            <div id="horizontal_deployment_fields" style="display: none;">
               <div class="department-list">
                  {% for dept in departments %}
                  {% if dept != request.active_profile.department %}
                  <div class="custom-control custom-checkbox mb-2">
                     <input type="checkbox" 
                        class="custom-control-input input-horizontal" 
                        id="dept_{{ dept }}" 
                        name="horizontal_departments" 
                        value="{{ dept }}"
                        disabled>
                     <label class="custom-control-label" for="dept_{{ dept }}">
                     {{ dept }}
                     </label>
                  </div>
                  {% endif %}
                  {% endfor %}
               </div>
            </div>
         </div>
         <hr class="my-4">
         <!-- Before/After Improvement Section -->
         <div class="pl-lg-4">
            <h6 class="heading-small text-muted mb-4">Improvement Documentation</h6>
            <div class="row">
               <!-- Before Improvement -->
               <div class="col-xl-6">
                  <div class="card">
                     <div class="card-header">
                        <h5 class="h3 mb-0">Before Improvement</h5>
                     </div>
                     <div class="card-body">
                        <div class="form-group">
                           <label class="form-control-label" for="id_before_improvement_text">Description</label>
                           <textarea class="form-control" id="id_before_improvement_text" name="before_improvement_text" rows="3" required></textarea>
                           <div class="custom-file mt-3">
                              <input type="file" class="custom-file-input" id="id_before_improvement_image" 
                                 name="before_improvement_image" accept="image/*">
                              <label class="custom-file-label" for="id_before_improvement_image"></label>
                           </div>
                           <div class="mt-3">
                              <img id="before-improvement-preview" src="#" alt="Before Improvement" 
                                 class="img-fluid rounded shadow" style="display: none; max-width: 200px;">
                           </div>
                        </div>
                     </div>
                  </div>
               </div>
               <!-- After Improvement -->
               <div class="col-xl-6">
                  <div class="card">
                     <div class="card-header">
                        <h5 class="h3 mb-0">After Improvement</h5>
                     </div>
                     <div class="card-body">
                        <div class="form-group">
                           <label class="form-control-label" for="id_after_improvement_text">Description</label>
                           <textarea class="form-control" id="id_after_improvement_text" name="after_improvement_text" rows="3" required></textarea>
                           <div class="custom-file mt-3">
                              <input type="file" class="custom-file-input" id="id_after_improvement_image" 
                                 name="after_improvement_image" accept="image/*">
                              <label class="custom-file-label" for="id_after_improvement_image"></label>
                           </div>
                           <div class="mt-3">
                              <img id="after-improvement-preview" src="#" alt="After Improvement" 
                                 class="img-fluid rounded shadow" style="display: none; max-width: 200px;">
                           </div>
                        </div>
                     </div>
                  </div>
               </div>
            </div>
         </div>
         <hr class="my-4">
         <!-- Impact Assessment Section -->
         <div class="pl-lg-4">
            <h6 class="heading-small text-muted mb-4">Impact Assessment</h6>
            <!-- Safety Impact -->
            <div class="card mb-3">
               <div class="card-header" id="heading_safety">
                  <div class="custom-control custom-checkbox">
                     <input type="checkbox" class="custom-control-input" 
                        id="id_impacts_safety" 
                        onclick="handleCheckboxClick('safety')">
                     <label class="custom-control-label" for="id_impacts_safety">
                     Safety
                     </label>
                  </div>
               </div>
               <div id="safety_fields" class="collapse" style="display: none;">
                  <div class="card-body">
                     <div class="row">
                        <div class="col-lg-12">
                           <div class="form-group">
                              <label class="form-control-label">Benefits Description</label>
                              <input type="text" id="id_safety_benefits_description" 
                                 name="safety_benefits_description" 
                                 class="form-control">
                           </div>
                        </div>
                        <div class="col-md-4">
                           <div class="form-group">
                              <label class="form-control-label">UOM</label>
                              <input type="text" id="id_safety_uom" 
                                 name="safety_uom" 
                                 class="form-control">
                           </div>
                        </div>
                        <div class="col-md-4">
                           <div class="form-group">
                              <label class="form-control-label">Before Implementation</label>
                              <input type="text" id="id_safety_before_implementation" 
                                 name="safety_before_implementation" 
                                 class="form-control">
                           </div>
                        </div>
                        <div class="col-md-4">
                           <div class="form-group">
                              <label class="form-control-label">After Implementation</label>
                              <input type="text" id="id_safety_after_implementation" 
                                 name="safety_after_implementation" 
                                 class="form-control">
                           </div>
                        </div>
                     </div>
                  </div>
               </div>
            </div>
            <!-- Quality Impact -->
            <div class="card mb-3">
               <div class="card-header" id="heading_quality">
                  <div class="custom-control custom-checkbox">
                     <input type="checkbox" class="custom-control-input" 
                        id="id_impacts_quality" 
                        onclick="handleCheckboxClick('quality')">
                     <label class="custom-control-label" for="id_impacts_quality">
                     Quality
                     </label>
                  </div>
               </div>
               <div id="quality_fields" class="collapse" style="display: none;">
                  <div class="card-body">
                     <div class="row">
                        <div class="col-lg-12">
                           <div class="form-group">
                              <label class="form-control-label">Benefits Description</label>
                              <input type="text" id="id_quality_benefits_description" 
                                 name="quality_benefits_description" 
                                 class="form-control">
                           </div>
                        </div>
                        <div class="col-md-4">
                           <div class="form-group">
                              <label class="form-control-label">UOM</label>
                              <input type="text" id="id_quality_uom" 
                                 name="quality_uom" 
                                 class="form-control">
                           </div>
                        </div>
                        <div class="col-md-4">
                           <div class="form-group">
                              <label class="form-control-label">Before Implementation</label>
                              <input type="text" id="id_quality_before_implementation" 
                                 name="quality_before_implementation" 
                                 class="form-control">
                           </div>
                        </div>
                        <div class="col-md-4">
                           <div class="form-group">
                              <label class="form-control-label">After Implementation</label>
                              <input type="text" id="id_quality_after_implementation" 
                                 name="quality_after_implementation" 
                                 class="form-control">
                           </div>
                        </div>
                     </div>
                  </div>
               </div>
            </div>
            <!-- Productivity Impact -->
            <div class="card mb-3">
               <div class="card-header" id="heading_productivity">
                  <div class="custom-control custom-checkbox">
                     <input type="checkbox" class="custom-control-input" 
                        id="id_impacts_productivity" 
                        onclick="handleCheckboxClick('productivity')">
                     <label class="custom-control-label" for="id_impacts_productivity">
                     Productivity
                     </label>
                  </div>
               </div>
               <div id="productivity_fields" class="collapse" style="display: none;">
                  <div class="card-body">
                     <div class="row">
                        <div class="col-lg-12">
                           <div class="form-group">
                              <label class="form-control-label">Benefits Description</label>
                              <input type="text" id="id_productivity_benefits_description" 
                                 name="productivity_benefits_description" 
                                 class="form-control">
                           </div>
                        </div>
                        <div class="col-md-4">
                           <div class="form-group">
                              <label class="form-control-label">UOM</label>
                              <input type="text" id="id_productivity_uom" 
                                 name="productivity_uom" 
                                 class="form-control">
                           </div>
                        </div>
                        <div class="col-md-4">
                           <div class="form-group">
                              <label class="form-control-label">Before Implementation</label>
                              <input type="text" id="id_productivity_before_implementation" 
                                 name="productivity_before_implementation" 
                                 class="form-control">
                           </div>
                        </div>
                        <div class="col-md-4">
                           <div class="form-group">
                              <label class="form-control-label">After Implementation</label>
                              <input type="text" id="id_productivity_after_implementation" 
                                 name="productivity_after_implementation" 
                                 class="form-control">
                           </div>
                        </div>
                     </div>
                  </div>
               </div>
            </div>
            <!-- Delivery Impact -->
            <div class="card mb-3">
               <div class="card-header" id="heading_delivery">
                  <div class="custom-control custom-checkbox">
                     <input type="checkbox" class="custom-control-input" 
                        id="id_impacts_delivery" 
                        onclick="handleCheckboxClick('delivery')">
                     <label class="custom-control-label" for="id_impacts_delivery">
                     Delivery
                     </label>
                  </div>
               </div>
               <div id="delivery_fields" class="collapse" style="display: none;">
                  <div class="card-body">
                     <div class="row">
                        <div class="col-lg-12">
                           <div class="form-group">
                              <label class="form-control-label">Benefits Description</label>
                              <input type="text" id="id_delivery_benefits_description" 
                                 name="delivery_benefits_description" 
                                 class="form-control">
                           </div>
                        </div>
                        <div class="col-md-4">
                           <div class="form-group">
                              <label class="form-control-label">UOM</label>
                              <input type="text" id="id_delivery_uom" 
                                 name="delivery_uom" 
                                 class="form-control">
                           </div>
                        </div>
                        <div class="col-md-4">
                           <div class="form-group">
                              <label class="form-control-label">Before Implementation</label>
                              <input type="text" id="id_delivery_before_implementation" 
                                 name="delivery_before_implementation" 
                                 class="form-control">
                           </div>
                        </div>
                        <div class="col-md-4">
                           <div class="form-group">
                              <label class="form-control-label">After Implementation</label>
                              <input type="text" id="id_delivery_after_implementation" 
                                 name="delivery_after_implementation" 
                                 class="form-control">
                           </div>
                        </div>
                     </div>
                  </div>
               </div>
            </div>
            <!-- Cost Impact -->
            <div class="card mb-3">
               <div class="card-header" id="heading_cost">
                  <div class="custom-control custom-checkbox">
                     <input type="checkbox" class="custom-control-input" 
                        id="id_impacts_cost" 
                        onclick="handleCheckboxClick('cost')">
                     <label class="custom-control-label" for="id_impacts_cost">
                     Cost
                     </label>
                  </div>
               </div>
               <div id="cost_fields" class="collapse" style="display: none;">
                  <div class="card-body">
                     <div class="row">
                        <div class="col-lg-12">
                           <div class="form-group">
                              <label class="form-control-label">Benefits Description</label>
                              <input type="text" id="id_cost_benefits_description" 
                                 name="cost_benefits_description" 
                                 class="form-control">
                           </div>
                        </div>
                        <div class="col-md-4">
                           <div class="form-group">
                              <label class="form-control-label">UOM</label>
                              <input type="text" id="id_cost_uom" 
                                 name="cost_uom" 
                                 class="form-control">
                           </div>
                        </div>
                        <div class="col-md-4">
                           <div class="form-group">
                              <label class="form-control-label">Before Implementation (₹)</label>
                              <input type="number" 
                                 id="id_cost_before_implementation" 
                                 name="cost_before_implementation" 
                                 class="form-control"
                                 onchange="checkApprovalRequirements()"
                                 min="0"
                                 step="1">
                           </div>
                        </div>
                        <div class="col-md-4">
                           <div class="form-group">
                              <label class="form-control-label">After Implementation (₹)</label>
                              <input type="number" 
                                 id="id_cost_after_implementation" 
                                 name="cost_after_implementation" 
                                 class="form-control"
                                 onchange="checkApprovalRequirements()"
                                 min="0"
                                 step="1">
                           </div>
                        </div>
                     </div>
                     <!-- Additional cost-specific fields -->
                     <div class="row mt-3">
                        <div class="col-12">
                           <div class="custom-file">
                              <input type="file" class="custom-file-input" id="id_cost_calculation" 
                                 name="cost_calculation" accept=".xlsx,.xls,image/*">
                              <label class="custom-file-label" for="id_cost_calculation"></label>
                           </div>
                           <small class="form-text text-muted">Upload Excel sheet or image for cost calculations</small>
                           <div id="cost-approval-message" class="alert mt-3" style="display: none;"></div>
                        </div>
                     </div>
                  </div>
               </div>
            </div>
            <!-- Morale Impact -->
            <div class="card mb-3">
               <div class="card-header" id="heading_morale">
                  <div class="custom-control custom-checkbox">
                     <input type="checkbox" class="custom-control-input" 
                        id="id_impacts_morale" 
                        onclick="handleCheckboxClick('morale')">
                     <label class="custom-control-label" for="id_impacts_morale">
                     Morale
                     </label>
                  </div>
               </div>
               <div id="morale_fields" class="collapse" style="display: none;">
                  <div class="card-body">
                     <div class="row">
                        <div class="col-lg-12">
                           <div class="form-group">
                              <label class="form-control-label">Benefits Description</label>
                              <input type="text" id="id_morale_benefits_description" 
                                 name="morale_benefits_description" 
                                 class="form-control">
                           </div>
                        </div>
                        <div class="col-md-4">
                           <div class="form-group">
                              <label class="form-control-label">UOM</label>
                              <input type="text" id="id_morale_uom" 
                                 name="morale_uom" 
                                 class="form-control">
                           </div>
                        </div>
                        <div class="col-md-4">
                           <div class="form-group">
                              <label class="form-control-label">Before Implementation</label>
                              <input type="text" id="id_morale_before_implementation" 
                                 name="morale_before_implementation" 
                                 class="form-control">
                           </div>
                        </div>
                        <div class="col-md-4">
                           <div class="form-group">
                              <label class="form-control-label">After Implementation</label>
                              <input type="text" id="id_morale_after_implementation" 
                                 name="morale_after_implementation" 
                                 class="form-control">
                           </div>
                        </div>
                     </div>
                  </div>
               </div>
            </div>
            <!-- Environment Impact -->
            <div class="card mb-3">
               <div class="card-header" id="heading_environment">
                  <div class="custom-control custom-checkbox">
                     <input type="checkbox" class="custom-control-input" 
                        id="id_impacts_environment" 
                        onclick="handleCheckboxClick('environment')">
                     <label class="custom-control-label" for="id_impacts_environment">
                     Environment
                     </label>
                  </div>
               </div>
               <div id="environment_fields" class="collapse" style="display: none;">
                  <div class="card-body">
                     <div class="row">
                        <div class="col-lg-12">
                           <div class="form-group">
                              <label class="form-control-label">Benefits Description</label>
                              <input type="text" id="id_environment_benefits_description" 
                                 name="environment_benefits_description" 
                                 class="form-control">
                           </div>
                        </div>
                        <div class="col-md-4">
                           <div class="form-group">
                              <label class="form-control-label">UOM</label>
                              <input type="text" id="id_environment_uom" 
                                 name="environment_uom" 
                                 class="form-control">
                           </div>
                        </div>
                        <div class="col-md-4">
                           <div class="form-group">
                              <label class="form-control-label">Before Implementation</label>
                              <input type="text" id="id_environment_before_implementation" 
                                 name="environment_before_implementation" 
                                 class="form-control">
                           </div>
                        </div>
                        <div class="col-md-4">
                           <div class="form-group">
                              <label class="form-control-label">After Implementation</label>
                              <input type="text" id="id_environment_after_implementation" 
                                 name="environment_after_implementation" 
                                 class="form-control">
                           </div>
                        </div>
                     </div>
                  </div>
               </div>
            </div>
            <!-- Form Actions -->
            <div class="text-center mt-4">
               <button type="submit" class="btn btn-maroon">Submit Kaizen</button>
               <button type="button" onclick="downloadCurrentFields()" class="btn btn-info ml-2">
               <i class="ni ni-cloud-download-95"></i> Download Excel
               </button>
            </div>
      </form>
      <!-- Edit Kaizen Section -->
      <div class="card mt-4">
      <div class="card-header">
      <h3 class="mb-0">Edit Kaizen</h3>
      </div>
      <div class="card-body">
      <div class="form-group">
      <select id="kaizen-select" name="kaizen_id" class="form-control" onchange="fetchKaizenData(this.value)">
      <option value="">Select a Kaizen</option>
      {% for kaizen in kaizen_list %}
      <option value="{{ kaizen.id }}">{{ kaizen.title }}</option>
      {% endfor %}
      </select>
      </div>
      </div>
      </div>
      <!-- Submissions Status Table -->
      <div class="card mt-4">
      <div class="card-header border-0">
      <h3 class="mb-0">My Submissions Status</h3>
      </div>
      <div class="table-responsive">
      <table class="table align-items-center table-flush">
      <thead class="thead-light">
      <tr>
      <th scope="col">Title</th>
      <th scope="col">Submission Date</th>
      <th scope="col">Status</th>
      </tr>
      </thead>
      <tbody>
      {% for sheet in kaizen_sheets %}
      <tr>
      <td>{{ sheet.title }}</td>
      <td>{{ sheet.created_at|date:"Y-m-d" }}</td>
      <td>
        {% if sheet.approval_status == 'completed' %}
            <span class="badge badge-success">Completed</span>
        {% elif sheet.approval_status == 'rejected_by_hod' %}
            <span class="badge badge-danger">Rejected by HOD</span>
        {% elif sheet.approval_status == 'rejected_by_coordinator' %}
            <span class="badge badge-danger">Rejected by Coordinator</span>
        {% elif sheet.approval_status == 'rejected_by_finance' %}
            <span class="badge badge-danger">Rejected by Finance</span>
        {% elif sheet.approval_status == 'finance_pending' %}
            <span class="badge badge-warning">Finance Approval Pending</span>
        {% elif sheet.approval_status == 'coordinator_pending' %}
            <span class="badge badge-info">Coordinator Approval Pending</span>
        {% else %}
            <span class="badge badge-secondary">HOD Approval Pending</span>
        {% endif %}
    </td>
      </tr>
      {% endfor %}
      </tbody>
      </table>
      </div>
      </div>
      <!-- Core Scripts -->
      <script src="{% static 'assets/vendor/jquery/dist/jquery.min.js' %}"></script>
      <script src="{% static 'assets/vendor/bootstrap/dist/js/bootstrap.bundle.min.js' %}"></script>
      <script src="{% static 'assets/js/argon.js' %}"></script>
      <script>

function updateHandwrittenSheet() {
    const formData = new FormData();
    const sheetId = document.getElementById('edit_sheet_select').value;
    const title = document.getElementById('edit_handwritten_title').value;
    const sheet = document.getElementById('edit_handwritten_sheet').files[0];
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

    if (!sheetId || !title) {
        alert('Please select a sheet and provide a title');
        return;
    }

    formData.append('sheet_id', sheetId);
    formData.append('handwritten_title', title);
    if (sheet) {
        formData.append('handwritten_sheet', sheet);
    }
    formData.append('form_type', 'edit_handwritten');

    const submitBtn = document.querySelector('#edit-handwritten-form button');
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<i class="fa fa-spinner fa-spin"></i> Updating...';

    fetch('/update-handwritten-sheet/', {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': csrfToken
        },
        credentials: 'same-origin'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Sheet updated successfully!');
            $('#edit-upload-modal').modal('hide');
            location.reload();
        } else {
            throw new Error(data.error || 'Unknown error occurred');
        }
    })
    .catch(error => {
        console.error('Update error:', error);
        alert('Error updating sheet: ' + error.message);
    })
    .finally(() => {
        submitBtn.disabled = false;
        submitBtn.innerHTML = 'Update';
    });
}

// Add event listener for populating edit form when sheet is selected
document.getElementById('edit_sheet_select').addEventListener('change', function() {
    const sheetId = this.value;
    if (!sheetId) return;

    const titleInput = document.getElementById('edit_handwritten_title');
    const selectedOption = this.options[this.selectedIndex];
    
    if (selectedOption.dataset.approved === 'true') {
        alert('Cannot edit approved sheets');
        this.value = '';
        titleInput.value = '';
        return;
    }
    
    titleInput.value = selectedOption.text;
});

         // Common sections array
         const SECTIONS = ['safety', 'quality', 'productivity', 'delivery', 'cost', 'morale', 'environment'];
         
         // Enable/disable inputs based on checkbox state
         function toggleInputs(checkbox, benefit) {
             const inputs = document.querySelectorAll(`.input-${benefit}`);
             inputs.forEach(input => input.disabled = !checkbox.checked);
         }
         
         // Show/hide fields based on checkbox state
         function toggleFields(section) {
             const checkbox = document.getElementById(`id_impacts_${section}`);
             const fields = document.getElementById(`${section}_fields`);
             fields.style.display = checkbox.checked ? 'block' : 'none';
         }
         
         // Set field value with null check
         function setFieldValue(fieldId, value) {
             const element = document.getElementById(fieldId);
             if (element) element.value = value || '';
         }
         
         // Set checkbox state
         function setCheckboxState(fieldId, value) {
             const element = document.getElementById(fieldId);
             if (element) element.checked = value || false;
         }
         
         // Set image preview
         function setImagePreview(previewId, imageUrl) {
             const preview = document.getElementById(previewId);
             if (preview) {
                 preview.src = imageUrl;
                 preview.style.display = 'block';
             }
         }
         
         // Show file note
         function showFileNote(inputId, filename) {
             const input = document.getElementById(inputId);
             if (!input) return;
         
             // Remove existing note if any
             const existingNote = input.parentNode.querySelector('.file-note');
             if (existingNote) existingNote.remove();
         
             const fileNote = document.createElement('p');
             fileNote.className = 'file-note';
             fileNote.textContent = `Current file: ${filename.split('/').pop()}`;
             input.parentNode.insertBefore(fileNote, input.nextSibling);
         }
         
         function updateProfile() {
            const formData = new FormData();
            const username = document.getElementById('edit_username').value;
            const password = document.getElementById('edit_password').value;
            const department = document.getElementById('edit_department').value;
            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

            formData.append('username', username);
            if (password) {
               formData.append('password', password);
            }
            formData.append('department', department);

            fetch('/update-profile/', {
               method: 'POST',
               body: formData,
               headers: {
                     'X-CSRFToken': csrfToken
               },
               credentials: 'same-origin'
            })
            .then(response => response.json())
            .then(data => {
               if (data.success) {
                     alert('Profile updated successfully! Please log in again.');
                     window.location.href = '/login/';
               } else {
                     alert('Error: ' + (data.error || 'Unknown error occurred'));
               }
            })
            .catch(error => {
               console.error('Update error:', error);
               alert('Error updating profile: ' + error.message);
            });
         }

         function deleteAccount() {
            if (!confirm('Are you sure you want to delete this profile? This action cannot be undone.')) {
               return;
            }

            fetch('/delete-account/', {
               method: 'POST',
               headers: {
                     'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                     'Content-Type': 'application/json'
               },
               credentials: 'same-origin'
            })
            .then(response => response.json())
            .then(data => {
               if (data.success) {
                     alert(data.message);
                     if (data.redirect) {
                        window.location.href = '/login/';
                     }
               } else {
                     alert('Error: ' + (data.error || 'Unknown error occurred'));
               }
            })
            .catch(error => {
               console.error('Delete error:', error);
               alert('Error deleting account: ' + error.message);
            });
         }


         function showDeploymentModal() {
             document.getElementById('deploymentModal').style.display = 'block';
         }
         
         function deployHorizontally() {
             const selectedDepts = [];
             document.querySelectorAll('.dept-checkbox input:checked').forEach(checkbox => {
                 selectedDepts.push(checkbox.value);
             });
         
             if (selectedDepts.length === 0) {
                 alert('Please select at least one department');
                 return;
             }
         
             const sheetId = document.getElementById('sheet_id').value;
             
             fetch('/deploy-horizontally/', {
                 method: 'POST',
                 headers: {
                     'Content-Type': 'application/json',
                     'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                 },
                 body: JSON.stringify({
                     sheet_id: sheetId,
                     departments: selectedDepts
                 })
             })
             .then(response => response.json())
             .then(data => {
                 if (data.success) {
                     alert('Successfully deployed to selected departments');
                     document.getElementById('deploymentModal').style.display = 'none';
                 } else {
                     alert('Error: ' + data.error);
                 }
             });
         }
         
         // Fetch and populate Kaizen data
         function handleCheckboxClick(section) {
         toggleFields(section);
         }   
         
         function hasImpactData(data, section) {
             const fields = ['benefits_description', 'uom', 'before_implementation', 'after_implementation'];
             return fields.some(field => {
                 const value = data[`${section}_${field}`];
                 return value && value.trim() !== '';
             });
         }
         
         // Initialize on page load
         document.addEventListener('DOMContentLoaded', () => {
             SECTIONS.forEach(toggleFields);
         });
             // Helper functions
             function clearImagePreview(previewId) {
                 const preview = document.getElementById(previewId);
                 if (preview) {
                     preview.src = '#';
                     preview.style.display = 'none';
                 }
             }
             
             function setImagePreview(previewId, imageUrl) {
                 const preview = document.getElementById(previewId);
                 if (preview) {
                     preview.src = imageUrl;
                     preview.style.display = 'block';
                     console.log(`Setting ${previewId} to:`, imageUrl);
                 }
             }
             
             function showFileNote(inputId, filename) {
                 const input = document.getElementById(inputId);
                 if (!input) return;
             
                 // Remove existing note
                 const existingNote = input.parentNode.querySelector('.file-note');
                 if (existingNote) existingNote.remove();
             
                 const fileNote = document.createElement('p');
                 fileNote.className = 'file-note';
                 fileNote.textContent = `Current file: ${filename.split('/').pop()}`;
                 input.parentNode.insertBefore(fileNote, input.nextSibling);
                 console.log(`Setting file note for ${inputId}:`, filename);
             }
             
             function validateForm(event) {
    event.preventDefault();
    
    const form = document.getElementById('main-kaizen-form');
    const formData = new FormData(form);
    
    // Add impact data to formData
    const impacts = ['safety', 'quality', 'productivity', 'delivery', 'cost', 'morale', 'environment'];
    impacts.forEach(impact => {
        const checkbox = document.getElementById(`id_impacts_${impact}`);
        if (checkbox && checkbox.checked) {
            formData.append(`id_impacts_${impact}`, 'on');
            
            // Add impact fields if checked
            ['benefits_description', 'uom', 'before_implementation', 'after_implementation'].forEach(field => {
                const fieldId = `id_${impact}_${field}`;
                const element = document.getElementById(fieldId);
                if (element) {
                    formData.append(fieldId, element.value);
                }
            });
        }
    });

    // Get CSRF token and submit
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    const submitButton = form.querySelector('button[type="submit"]');
    
    // Disable submit button and show loading state
    submitButton.disabled = true;
    submitButton.innerHTML = '<i class="fa fa-spinner fa-spin"></i> Submitting...';

    // Submit form data
    fetch('/save-kaizen-sheet/', {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': csrfToken,
            'X-Requested-With': 'XMLHttpRequest'
        },
        credentials: 'same-origin'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Kaizen sheet saved successfully!');
            location.reload();
        } else {
            alert('Error: ' + (data.error || 'Unknown error occurred'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error saving kaizen sheet: ' + error.message);
    })
    .finally(() => {
        submitButton.disabled = false;
        submitButton.innerHTML = 'Submit Kaizen';
    });

    return false;
}
         
             function toggleHorizontalDeployment(checkbox) {
                 const fields = document.getElementById('horizontal_deployment_fields');
                 fields.style.display = checkbox.checked ? 'block' : 'none';
                 
                 const inputs = document.querySelectorAll('.input-horizontal');
                 inputs.forEach(input => {
                     input.disabled = !checkbox.checked;
                 });
                 
                 // Debug log
                 console.log('Horizontal deployment toggled:', checkbox.checked);
                 if (checkbox.checked) {
                     console.log('Enabled departments:', 
                         Array.from(document.querySelectorAll('.input-horizontal:checked'))
                             .map(cb => cb.value)
                     );
                 }
             }
             
             function fetchKaizenData(kaizenId) {
    if (!kaizenId) return;
    
    const form = document.getElementById('main-kaizen-form');
    if (!form) {
        console.error('Form not found');
        return;
    }
    
    form.style.opacity = '0.5';
    clearPreviews();
    
    fetch(`/fetch-kaizen-sheet/${kaizenId}/`, {
        method: 'GET',
        headers: {
            'Accept': 'application/json',
            'X-Requested-With': 'XMLHttpRequest',
        },
        credentials: 'same-origin'
    })
    .then(response => {
        if (!response.ok) {
            if (response.status === 403) {
                return response.json().then(data => {
                    if (data.is_approved) {
                        alert('Cannot edit approved sheets');
                    }
                    throw new Error('Cannot edit this sheet');
                });
            }
            throw new Error('Network response was not ok');
        }
        return response.json();
    })
    .then(data => {
        console.log('Fetched data:', data);
        
        try {
            // Set basic fields
            setBasicFields(data);
            
            // Handle impacts
            ['safety', 'quality', 'productivity', 'delivery', 'cost', 'morale', 'environment']
            .forEach(impact => {
                const checkbox = document.getElementById(`id_impacts_${impact}`);
                const fields = document.getElementById(`${impact}_fields`);
                
                if (checkbox && fields) {
                    // Check if impact has data
                    const hasData = [
                        `${impact}_benefits_description`,
                        `${impact}_uom`,
                        `${impact}_before_implementation`,
                        `${impact}_after_implementation`
                    ].some(field => data[field]);
                    
                    // Set checkbox state and show/hide fields
                    checkbox.checked = hasData;
                    fields.style.display = hasData ? 'block' : 'none';
                    
                    if (hasData) {
                        // Set field values
                        setFieldValue(`id_${impact}_benefits_description`, data[`${impact}_benefits_description`]);
                        setFieldValue(`id_${impact}_uom`, data[`${impact}_uom`]);
                        setFieldValue(`id_${impact}_before_implementation`, data[`${impact}_before_implementation`]);
                        setFieldValue(`id_${impact}_after_implementation`, data[`${impact}_after_implementation`]);
                    }
                }
            });

            // Handle files and other data
            handleFiles(data);
            handleHorizontalDeployment(data);
            setHiddenFields(form, kaizenId);

        } catch (error) {
            console.error('Error processing data:', error);
            alert('Error processing Kaizen data: ' + error.message);
        }
        
        form.style.opacity = '1';
    })
    .catch(error => {
        console.error('Error fetching Kaizen data:', error);
        form.style.opacity = '1';
        alert('Error loading Kaizen data. Please try again.');
    });
}

function clearPreviews() {
    clearImagePreview('before-improvement-preview');
    clearImagePreview('after-improvement-preview');
    document.querySelectorAll('.file-note').forEach(note => note.remove());
}

function setBasicFields(data) {
    // Set dates
    if (data.start_date) {
        document.getElementById('id_start_date').value = data.start_date.split('T')[0];
    }
    if (data.end_date) {
        document.getElementById('id_end_date').value = data.end_date.split('T')[0];
    }

    // Set other basic fields
    ['title', 'area_implemented', 'problem', 'idea_solved', 'standardization', 'deployment',
     'team_member2_id', 'team_member2'].forEach(field => {
        setFieldValue(`id_${field}`, data[field]);
    });

    // Set area grouping
    if (data.area_grouping) {
        const areaSelect = document.getElementById('area_grouping');
        Array.from(areaSelect.options).forEach(option => {
            option.selected = option.value === data.area_grouping;
        });
    }

    // Set improvement texts
    ['before', 'after'].forEach(type => {
        setFieldValue(`id_${type}_improvement_text`, data[`${type}_improvement_text`]);
    });
}

function handleHorizontalDeployment(data) {
    const horizCheckbox = document.getElementById('id_horizontal_deployment');
    const fields = document.getElementById('horizontal_deployment_fields');
    
    if (horizCheckbox && fields && data.horizontal_departments) {
        const hasDeployments = data.horizontal_departments.length > 0;
        horizCheckbox.checked = hasDeployments;
        fields.style.display = hasDeployments ? 'block' : 'none';
        
        document.querySelectorAll('input[name="horizontal_departments"]')
            .forEach(box => {
                box.checked = data.horizontal_departments.includes(box.value);
                box.disabled = !hasDeployments;
            });
    }
}

function handleFiles(data) {
    if (data.before_improvement_image) {
        setImagePreview('before-improvement-preview', data.before_improvement_image);
    }
    if (data.after_improvement_image) {
        setImagePreview('after-improvement-preview', data.after_improvement_image);
    }
    if (data.standardization_file) {
        showFileNote('id_standardization_file', data.standardization_file);
    }
    if (data.cost_calculation) {
        showFileNote('id_cost_calculation', data.cost_calculation);
    }
}

function setHiddenFields(form, kaizenId) {
    let hiddenInput = document.getElementById('edit_kaizen_id');
    if (!hiddenInput) {
        hiddenInput = document.createElement('input');
        hiddenInput.type = 'hidden';
        hiddenInput.id = 'edit_kaizen_id';
        hiddenInput.name = 'kaizen_id';
        form.appendChild(hiddenInput);
    }
    hiddenInput.value = kaizenId;
}
             
         function downloadCurrentFields() {
             const kaizenId = document.getElementById('kaizen-select').value;
             
             if (!kaizenId) {
                 alert('Please select a Kaizen to download');
                 return;
             }
             
             // Show loading state on button
             const downloadBtn = document.querySelector('.btn-info');
             const originalHtml = downloadBtn.innerHTML;
             downloadBtn.innerHTML = '<i class="ni ni-settings-gear-65 spin"></i> Downloading...';
             downloadBtn.disabled = true;
         
             // Add spinner animation
             const style = document.createElement('style');
             style.textContent = `
                 .spin {
                     animation: spin 1s linear infinite;
                 }
                 @keyframes spin {
                     100% { transform: rotate(360deg); }
                 }
             `;
             document.head.appendChild(style);
         
             // Request the Excel file
             fetch(`/download-kaizen-sheet/${kaizenId}/`)
                 .then(response => {
                     if (!response.ok) throw new Error('Network response was not ok');
                     return response.blob();
                 })
                 .then(blob => {
                     // Create and trigger download
                     const url = window.URL.createObjectURL(blob);
                     const a = document.createElement('a');
                     a.style.display = 'none';
                     a.href = url;
                     a.download = `Kaizen_Sheet_${kaizenId}.xlsx`;
                     document.body.appendChild(a);
                     a.click();
                     window.URL.revokeObjectURL(url);
                     
                     // Reset button state
                     downloadBtn.innerHTML = originalHtml;
                     downloadBtn.disabled = false;
                 })
                 .catch(error => {
                     console.error('Download error:', error);
                     alert('Error downloading file. Please try again.');
                     downloadBtn.innerHTML = originalHtml;
                     downloadBtn.disabled = false;
                 });
         }
         
         // Initialize Bootstrap components
         $(document).ready(function() {
             // Initialize Bootstrap modal
             $('#upload-modal').modal({
                 backdrop: 'static',
                 keyboard: false,
                 show: false
             });
         
             // Update modal trigger
             $('#upload-kaizen-btn').click(function() {
                 $('#upload-modal').modal('show');
             });
         
             // Add event listener for handwritten form submission
             $('#handwritten-form').on('submit', function(e) {
                 e.preventDefault();
                 uploadHandwrittenSheet();
             });
         });
         
         // In your employee_dashboard.html script section
         const modal = document.getElementById("upload-modal");
         const btn = document.getElementById("upload-kaizen-btn");
         const span = document.getElementsByClassName("close")[0];
         
         btn.onclick = () => modal.style.display = "block";
         span.onclick = () => modal.style.display = "none";
         window.onclick = (event) => {
             if (event.target == modal) {
                 modal.style.display = "none";
             }
         };
         
         function uploadHandwrittenSheet() {
            const formData = new FormData();
            const title = document.getElementById('handwritten_title').value;
            const sheet = document.getElementById('handwritten_sheet').files[0];
            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
            const submitBtn = document.querySelector('#handwritten-form button');

            if (!title || !sheet) {
               alert('Please fill in all required fields for handwritten sheet');
               return;
            }

            formData.append('handwritten_title', title);
            formData.append('handwritten_sheet', sheet);
            formData.append('form_type', 'handwritten');

            // Disable button and show loading state
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fa fa-spinner fa-spin"></i> Uploading...';

            fetch('/upload-handwritten-sheet/', {
               method: 'POST',
               body: formData,
               headers: {
                     'X-CSRFToken': csrfToken
               },
               credentials: 'same-origin'
            })
            .then(response => response.json())
            .then(data => {
               if (data.success) {
                     alert(`Handwritten sheet uploaded successfully!\nSerial Key: ${data.serial_key}`);
                     $('#upload-modal').modal('hide');
                     document.getElementById('handwritten-form').reset();
                     location.reload(); // Refresh to show new submission
               } else {
                     alert('Error: ' + (data.error || 'Unknown error occurred'));
               }
            })
            .catch(error => {
               console.error('Upload error:', error);
               alert('Error uploading sheet: ' + error.message);
            })
            .finally(() => {
               // Reset button state
               submitBtn.disabled = false;
               submitBtn.innerHTML = 'Submit';
            });
         }
         
         
         function checkApprovalRequirements() {
             const beforeCost = parseFloat(document.getElementById('id_cost_before_implementation').value) || 0;
             const afterCost = parseFloat(document.getElementById('id_cost_after_implementation').value) || 0;
             const costDifference = Math.abs(beforeCost - afterCost);
             const messageContainer = document.getElementById('cost-approval-message');
             
             if (!messageContainer) {
                 const container = document.createElement('div');
                 container.id = 'cost-approval-message';
                 container.className = 'alert mt-3';
                 document.getElementById('cost_fields').querySelector('.card-body').appendChild(container);
             }
             
             let message = '';
             let messageClass = '';
             
             if (costDifference > 100000) {
                 message = `
                     <div class="approval-flow">
                         <p><strong>Approval Flow Required:</strong></p>
                         <ol>
                             <li>HOD Approval</li>
                             <li>Finance Approval</li>
                             <li>Coordinator Approval</li>
                         </ol>
                         <p class="text-danger">Finance approval required (Above ₹1,00,000)</p>
                     </div>`;
                 messageClass = 'alert-danger';
             } else if (costDifference > 45000) {
                 message = `
                     <div class="approval-flow">
                         <p><strong>Approval Flow Required:</strong></p>
                         <ol>
                             <li>HOD Approval</li>
                             <li>Coordinator Approval</li>
                         </ol>
                         <p class="text-warning">Coordinator approval required (Above ₹45,000)</p>
                     </div>`;
                 messageClass = 'alert-warning';
             } else if (costDifference > 0) {
                 message = `
                     <div class="approval-flow">
                         <p><strong>Approval Flow Required:</strong></p>
                         <ol>
                             <li>HOD Approval</li>
                         </ol>
                         <p class="text-info">HOD approval required</p>
                     </div>`;
                 messageClass = 'alert-info';
             }
             
             messageContainer.className = `alert mt-3 ${messageClass}`;
             messageContainer.innerHTML = message;
         }
         
         function toggleDeploymentModal() {
             const modal = document.getElementById('deploymentModal');
             const deptList = modal.querySelector('.department-list');
             modal.style.display = 'block';
             deptList.style.display = 'block';
         }
         
         function closeDeploymentModal() {
             const modal = document.getElementById('deploymentModal');
             const deptList = modal.querySelector('.department-list');
             modal.style.display = 'none';
             deptList.style.display = 'none';
         }
         
         // Update window click handler
         window.onclick = (event) => {
             if (event.target.className === 'modal') {
                 closeDeploymentModal();
             }
         };
             
         function checkPasswordAge() {
    // Remove any existing warning
    const existingWarning = document.querySelector('#profile-edit-modal .alert-warning');
    if (existingWarning) {
        existingWarning.remove();
    }

    fetch('/check-password-age/', {
        method: 'GET',
        credentials: 'same-origin',
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success && data.should_change_password) {
            const warningDiv = document.createElement('div');
            warningDiv.className = 'alert alert-warning mt-3';
            warningDiv.innerHTML = `
                <i class="fas fa-exclamation-triangle"></i>
                Your password is ${data.days_since_change} days old. For security reasons, please change your password if it's been more than 40 days.
            `;
            const modalBody = document.querySelector('#profile-edit-modal .modal-body');
            modalBody.insertBefore(warningDiv, modalBody.firstChild);
        }
    })
    .catch(error => console.error('Error checking password age:', error));
}

// Add this to each dashboard's JavaScript section
document.addEventListener('DOMContentLoaded', function() {
    // Check password age when profile modal is opened
    $('#profile-edit-modal').on('show.bs.modal', function () {
        checkPasswordAge();
    });
});

      </script>
      </div>
      <style>
         .approval-flow {
         font-size: 0.9rem;
         }
         .approval-flow ol {
         margin: 10px 0;
         padding-left: 20px;
         }
         .approval-flow li {
         margin-bottom: 5px;
         }
         .approval-flow p:last-child {
         margin-bottom: 0;
         font-weight: 600;
         }
         input[type="number"] {
         appearance: textfield;
         -moz-appearance: textfield;
         }
         input[type="number"]::-webkit-outer-spin-button,
         input[type="number"]::-webkit-inner-spin-button {
         -webkit-appearance: none;
         margin: 0;
         }
         .alert-warning {
        color: #856404;
        background-color: #fff3cd;
        border-color: #ffeeba;
        padding: 0.75rem 1.25rem;
        margin-bottom: 1rem;
        border: 1px solid transparent;
        border-radius: 0.375rem;
    }
    .alert-warning i {
        margin-right: 0.5rem;
    }
      </style>
   </body>
</html>